<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Inbox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Global Design System -->
  <link href="/css/global-design.css" rel="stylesheet">

  <style>
    .brand-red { color: var(--primary); }
    .item-row { background: white; border-radius: 14px; box-shadow: 0 8px 32px rgba(45, 90, 79, 0.1); }
    .avatar { width: 44px; height: 44px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary); }
    .muted { color:#6c757d; }
    .notif-unread { border-left: 5px solid #e60000; }
    .pill { font-size:.75rem; border-radius:999px; padding:.15rem .55rem; background:rgba(45, 90, 79, 0.08); color: var(--primary); font-weight:700; }
    a.link { text-decoration:none; color:#111; }
    a.link:hover { text-decoration:underline; }
    .match-status-badge { font-size: 0.75rem; border-radius: 999px; padding: 0.25rem 0.75rem; font-weight: 700; }
    .status-pending { background: rgba(255, 193, 7, 0.15); color: #ff9800; }
    .status-agreed { background: rgba(76, 175, 80, 0.15); color: #4caf50; }
    .status-completed { background: rgba(33, 150, 243, 0.15); color: #2196f3; }
    .status-cancelled { background: rgba(244, 67, 54, 0.15); color: #f44336; }
    .swap-match-item { display: flex; gap: 12px; align-items: center; padding: 8px 0; }
    .item-image { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; }
    .swap-match-info { flex-grow: 1; }
    .swap-vs { text-align: center; color: var(--primary); font-weight: bold; font-size: 0.9rem; margin: 0 8px; }

    /* Frutiger Metro Dynamic Background */
    body {
        background: linear-gradient(45deg, #E8F4F8, #F0E8F8, #F8F0E8, #E8F8F0, #F8F0F0, #E8F4F8);
        background-size: 400% 400%;
        animation: metro-flow 30s ease infinite;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, rgba(0, 120, 215, 0.12) 0%, transparent 30%, transparent 70%, rgba(0, 120, 215, 0.12) 100%),
            linear-gradient(180deg, rgba(255, 140, 0, 0.08) 0%, transparent 40%, transparent 60%, rgba(255, 140, 0, 0.08) 100%),
            linear-gradient(45deg, rgba(107, 142, 35, 0.1) 0%, transparent 50%, transparent 50%, rgba(107, 142, 35, 0.1) 100%);
        animation: metro-grid 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 0%, rgba(0, 120, 215, 0.05) 25%, rgba(0, 120, 215, 0.05) 75%, transparent 100%),
            linear-gradient(0deg, transparent 0%, rgba(255, 140, 0, 0.04) 50%, transparent 100%);
        background-size: 200% 100%, 100% 200%;
        animation: metro-slide 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes metro-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes metro-grid {
        0%, 100% { transform: scale(1) translateY(0); filter: brightness(1); }
        25% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
        50% { transform: scale(1.01) translateY(-10px); filter: brightness(1.05); }
        75% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
    }

    @keyframes metro-slide {
        0%, 100% { background-position: 0% 0%, 0% 0%; }
        50% { background-position: 100% 0%, 0% 100%; }
    }

    body > * {
        position: relative;
        z-index: 1;
    }
  </style>
</head>
<body>

  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/">Clothes <span class="brand-red">Swap</span></a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0" style="display: flex; align-items: center; gap: 0.8rem;">
          <li class="nav-item"><a class="nav-link" aria-current="page" href="/">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="/inbox">Inbox</a></li>
          <li class="nav-item"><a class="nav-link" href="/wardrobe">Wardrobe</a></li>
          <li class="nav-item"><a class="nav-link" href="/swap">Swap</a></li>
          <li class="nav-item"><a class="nav-link" href="/sahm">SwapMates</a></li>
          <li class="nav-item"><a class="nav-link" href="/profile">Profile</a></li>
          <li class="nav-item ms-lg-2"><a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.7rem 1.6rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2); font-size: 0.95rem; font-family: 'Cinzel', serif; letter-spacing: 0.08em; text-transform: uppercase; display: flex; align-items: center;" href="/logout" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <h5 class="mb-0">Inbox</h5>
    </div>

    <% 
      const hasNotifications = notifications && notifications.length > 0;
      const hasSwapMatches = swapMatches && swapMatches.length > 0;
      const isEmpty = !hasNotifications && !hasSwapMatches;
    %>

    <% if (isEmpty) { %>
      <div class="text-center text-muted py-5">No activity yet.</div>
    <% } %>

    <!-- SWAP MATCHES SECTION -->
    <% if (hasSwapMatches) { %>
      <div class="mb-5">
        <div class="d-flex align-items-center gap-2 mb-3">
          <h6 class="mb-0">Swap Matches</h6>
          <span class="pill"><%= swapMatches.length %> match<%= swapMatches.length !== 1 ? 'es' : '' %></span>
        </div>

        <div class="d-flex flex-column gap-3">
          <% swapMatches.forEach(match => { %>
            <div class="item-row p-4">
              <!-- User Info -->
              <div class="d-flex gap-3 align-items-start mb-3">
                <% if (match.other_user_profile_image) { %>
                  <img src="<%= match.other_user_profile_image %>" class="avatar" alt="avatar">
                <% } else { %>
                  <div class="avatar d-flex align-items-center justify-content-center bg-light text-muted">
                    <%= (match.other_user_username || '?').charAt(0).toUpperCase() %>
                  </div>
                <% } %>

                <div class="flex-grow-1">
                  <div>
                    <a class="link" href="/users/<%= match.other_user_id %>"><strong><%= match.other_user_username %></strong></a>
                    wants to swap
                  </div>
                  <div class="muted small mt-1">
                    <%= new Date(match.created_at).toLocaleString() %>
                  </div>
                </div>

                <span class="match-status-badge status-<%= match.status %>">
                  <%= match.status.charAt(0).toUpperCase() + match.status.slice(1) %>
                </span>
              </div>

              <!-- Items Being Swapped -->
              <div class="mb-3">
                <div class="swap-match-item">
                  <div class="swap-match-info">
                    <div class="muted small">Your item</div>
                    <% if (match.my_item_image) { %>
                      <img src="<%= match.my_item_image %>" class="item-image" alt="item">
                    <% } %>
                    <div class="fw-bold mt-1"><%= match.my_item_title %></div>
                  </div>

                  <div class="swap-vs">‚áÑ</div>

                  <div class="swap-match-info">
                    <div class="muted small">Their item</div>
                    <% if (match.other_user_item_image) { %>
                      <img src="<%= match.other_user_item_image %>" class="item-image" alt="item">
                    <% } %>
                    <div class="fw-bold mt-1"><%= match.other_user_item_title %></div>
                  </div>
                </div>
              </div>

              <!-- Swap Details -->
              <% if (match.swap_method || match.payment_split) { %>
                <div class="mb-3 p-2 bg-light rounded small">
                  <% if (match.swap_method) { %>
                    <div><strong>Method:</strong> <%= match.swap_method === 'sahm' ? 'SwapMates Delivery' : (match.swap_method.charAt(0).toUpperCase() + match.swap_method.slice(1)) %></div>
                  <% } %>
                  <% if (match.payment_split) { %>
                    <div><strong>Payment:</strong> <%= match.payment_split.replace(/_/g, ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ') %></div>
                  <% } %>
                </div>
              <% } %>

              <!-- Action Buttons -->
              <div class="d-flex gap-2">
                <a href="/chat/<%= match.match_id %>" class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.5rem 1.2rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">
                  View Chat
                </a>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
    <% } %>

    <!-- NOTIFICATIONS SECTION -->
    <% if (hasNotifications) { %>
      <div>
        <div class="d-flex align-items-center gap-2 mb-3">
          <h6 class="mb-0">Activity</h6>
          <span class="pill"><%= notifications.length %> notification<%= notifications.length !== 1 ? 's' : '' %></span>
        </div>

        <div class="d-flex flex-column gap-3">
          <% notifications.forEach(n => { %>
            <div class="item-row p-4 d-flex gap-3 align-items-start <%= n.is_read ? '' : 'notif-unread' %>">

              <% if (n.actor_profile_image) { %>
                <img src="<%= n.actor_profile_image %>" class="avatar" alt="avatar">
              <% } else { %>
                <div class="avatar d-flex align-items-center justify-content-center bg-light text-muted">
                  <%= (n.actor_username || '?').charAt(0).toUpperCase() %>
                </div>
              <% } %>

              <div class="flex-grow-1">
                <div class="mb-2">
                  <a class="link" href="/users/<%= n.actor_user_id %>"><strong style="font-size: 1.1rem; color: var(--primary);"><%= n.actor_username %></strong></a>

                  <% if (n.type === 'like') { %>
                    <span style="color: #6c757d;">‚ù§Ô∏è liked your post</span>
                  <% } else if (n.type === 'comment') { %>
                    <span style="color: #6c757d;">üí¨ commented:</span>
                  <% } else { %>
                    <span style="color: #6c757d;">interacted with your post</span>
                  <% } %>
                </div>

                <% if (n.type === 'comment' && n.comment_preview) { %>
                  <div class="mb-2 p-2 bg-light rounded" style="border-left: 3px solid var(--primary);">
                    <em>"<%= n.comment_preview %>"</em>
                  </div>
                <% } %>

                <div class="muted small mb-2">
                  <%= new Date(n.created_at).toLocaleString() %>
                </div>

                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-secondary" href="/">View Post</a>

                  <form action="/inbox/<%= n.notification_id %>/read" method="POST" class="d-inline">
                    <button class="btn btn-sm btn-outline-secondary" type="submit">
                      Mark read
                    </button>
                  </form>
                </div>
              </div>

            </div>
          <% }) %>
        </div>
      </div>
    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
