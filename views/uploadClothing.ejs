<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Add Item | Clothes Swap</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Global Design System -->
    <link href="/css/global-design.css" rel="stylesheet">

    <style>

        .navbar-brand {
            font-weight: 700;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            font-size: 1rem;
        }

        .brand-red {
            color: #e60000;
        }

        .page-header {
            margin-top: 1.5rem;
            margin-bottom: 1rem;
        }

        .page-title {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .page-subtitle {
            font-size: 0.9rem;
            color: #6c757d;
        }

        .card-upload {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.06);
            background-color: #fff;
        }

        .form-label {
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control, .form-select {
            border-radius: 10px;
        }

        .hint-text {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .alert-message {
            border-radius: 10px;
        }

        .btn-primary-custom {
            background-color: #e60000;
            border-color: #e60000;
            border-radius: 999px;
            font-weight: 600;
            padding: 0.55rem 1.5rem;
        }

        .btn-primary-custom:hover {
            background-color: #cc0000;
            border-color: #cc0000;
        }

        .badge-suggestion {
            display: inline-block;
            border-radius: 999px;
            background-color: #f1f1f1;
            color: #555;
            padding: 0.15rem 0.6rem;
            font-size: 0.75rem;
            margin: 0 0.25rem 0.25rem 0;
        }

        .required {
            color: #e60000;
        }

        .back-link {
            font-size: 0.85rem;
            text-decoration: none;
            color: #6c757d;
        }

        .back-link:hover {
            text-decoration: underline;
            color: #333;
        }

    /* Frutiger Metro Dynamic Background */
    body {
        background: linear-gradient(45deg, #E8F4F8, #F0E8F8, #F8F0E8, #E8F8F0, #F8F0F0, #E8F4F8);
        background-size: 400% 400%;
        animation: metro-flow 30s ease infinite;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, rgba(0, 120, 215, 0.12) 0%, transparent 30%, transparent 70%, rgba(0, 120, 215, 0.12) 100%),
            linear-gradient(180deg, rgba(255, 140, 0, 0.08) 0%, transparent 40%, transparent 60%, rgba(255, 140, 0, 0.08) 100%),
            linear-gradient(45deg, rgba(107, 142, 35, 0.1) 0%, transparent 50%, transparent 50%, rgba(107, 142, 35, 0.1) 100%);
        animation: metro-grid 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 0%, rgba(0, 120, 215, 0.05) 25%, rgba(0, 120, 215, 0.05) 75%, transparent 100%),
            linear-gradient(0deg, transparent 0%, rgba(255, 140, 0, 0.04) 50%, transparent 100%);
        background-size: 200% 100%, 100% 200%;
        animation: metro-slide 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes metro-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes metro-grid {
        0%, 100% { transform: scale(1) translateY(0); filter: brightness(1); }
        25% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
        50% { transform: scale(1.01) translateY(-10px); filter: brightness(1.05); }
        75% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
    }

    @keyframes metro-slide {
        0%, 100% { background-position: 0% 0%, 0% 0%; }
        50% { background-position: 100% 0%, 0% 100%; }
    }

    body > * {
        position: relative;
        z-index: 1;
    }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
    <div class="container">
        <a class="navbar-brand" href="/">
            <span class="brand-red">CLOTHES</span> SWAP
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">

                <li class="nav-item">
                    <a class="nav-link" href="/">Home</a>
                </li>

                <% if (user) { %>
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/wardrobe">Wardrobe</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/swap">Swap</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/sahm">SwapMates</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/profile">Profile</a>
                    </li>
                    <li class="nav-item ms-lg-3">
                        <a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.5rem 1.2rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2);" href="/logout" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Logout</a>
                    </li>
                <% } else { %>
                    <li class="nav-item ms-lg-3">
                        <a class="btn btn-sm btn-outline-danger" href="/login">Sign In</a>
                    </li>
                <% } %>
            </ul>
        </div>
    </div>
</nav>

<div class="container py-4">

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center page-header">
        <div>
            <div class="page-title">Add Item to Wardrobe</div>
            <div class="page-subtitle">
                Upload an item, set its details, and choose if it‚Äôs for personal use or swapping.
            </div>
        </div>
        <div>
            <a href="/wardrobe" class="back-link">&larr; Back to Wardrobe</a>
        </div>
    </div>

    <!-- Flash / local messages -->
    <div class="mt-2">
        <% if (typeof success_msg !== 'undefined' && success_msg && success_msg.length > 0) { %>
            <div class="alert alert-success alert-message"><%= success_msg %></div>
        <% } %>

        <% if (typeof error_msg !== 'undefined' && error_msg && error_msg.length > 0) { %>
            <div class="alert alert-danger alert-message"><%= error_msg %></div>
        <% } %>

        <% if (message) { %>
            <div class="alert alert-info alert-message"><%= message %></div>
        <% } %>
    </div>

    <!-- Upload form card -->
    <div class="card card-upload mt-3">
        <div class="card-body p-4">
            <form action="/wardrobe/upload" method="POST" enctype="multipart/form-data">

                <!-- Title -->
                <div class="mb-3">
                    <label for="title" class="form-label">Item Title <span class="required">*</span></label>
                    <input
                        type="text"
                        class="form-control"
                        id="title"
                        name="title"
                        placeholder="e.g. Oversized Denim Jacket"
                        minlength="3"
                        maxlength="120"
                        required
                        oninput="updateTagSuggestionVisibility()"
                    >
                    <div class="hint-text mt-1">
                        3-120 characters. Be specific and descriptive (helps with recommendations!)
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label for="description" class="form-label">Description</label>
                    <textarea
                        class="form-control"
                        id="description"
                        name="description"
                        rows="3"
                        placeholder="Optional: add notes about fit, flaws, how you style it, etc."
                    ></textarea>
                </div>

                <!-- Brand (dynamic) -->
                <div class="mb-3">
                    <label for="brand" class="form-label">Brand <span class="required">*</span></label>
                    <input
                        type="text"
                        class="form-control"
                        id="brand"
                        name="brand"
                        placeholder="e.g. Uniqlo, Zara"
                        required
                    >
                    <div class="hint-text mt-1">
                        Start typing your brand. If it doesn‚Äôt exist yet, it‚Äôll be created automatically.
                    </div>

                    <% if (brands && brands.length > 0) { %>
                        <div class="hint-text mt-1">
                            Common brands:
                            <br>
                            <% brands.forEach(b => { %>
                                <span class="badge-suggestion"><%= b.name %></span>
                            <% }) %>
                        </div>
                    <% } %>
                </div>

                <!-- Category + Size -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="category" class="form-label">Category <span class="required">*</span></label>
                        <select class="form-select" id="category" name="category" required>
                            <option value="">Select category</option>
                            <option value="top">Top</option>
                            <option value="bottom">Bottom</option>
                            <option value="blouse">Blouse</option>
                            <option value="jeans">Jeans</option>
                            <option value="dress">Dress</option>
                            <option value="outerwear">Outerwear</option>
                            <option value="accessory">Accessory</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="size_label" class="form-label">Size</label>
                        <input
                            type="text"
                            class="form-control"
                            id="size_label"
                            name="size_label"
                            placeholder="e.g. S, M, L, 32, Free size"
                        >
                    </div>
                </div>

                <!-- Color + Condition -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="color" class="form-label">Color</label>
                        <input
                            type="text"
                            class="form-control"
                            id="color"
                            name="color"
                            placeholder="e.g. Black, Light Blue"
                        >
                    </div>

                    <div class="col-md-6 mb-3">
                        <label for="condition_grade" class="form-label">Condition</label>
                        <select class="form-select" id="condition_grade" name="condition_grade">
                            <option value="">Select condition</option>
                            <option value="new">New</option>
                            <option value="like_new">Like new</option>
                            <option value="good">Good</option>
                            <option value="fair">Fair</option>
                            <option value="worn">Worn</option>
                        </select>
                    </div>
                </div>

                <!-- Smart Tag Suggestions -->
                <div class="mb-3" id="tagSuggestionsSection" style="padding: 1rem; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb; display: none;">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 1rem;">
                        <button type="button" id="suggestTagsBtn" style="background: #e60000; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem;">
                            ü§ñ Get AI Tag Suggestions
                        </button>
                        <span id="tagsLoadingIndicator" style="display: none; color: #e60000; font-size: 0.85rem; font-weight: 500;">Loading suggestions...</span>
                    </div>
                    
                    <div id="suggestedTagsList" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 1rem;"></div>
                </div>

                <!-- Tags (dynamic) -->
                <div class="mb-3">
                    <label for="tags" class="form-label">Tags <span class="required">*</span></label>
                    <input
                        type="text"
                        class="form-control"
                        id="tags"
                        name="tags"
                        placeholder="e.g. streetwear, oversized, casual"
                        required
                    >
                    <div class="hint-text mt-1">
                        Use comma-separated tags. These power recommendations and swipe logic. üí° Tip: Use the AI suggestions above to help!
                    </div>

                    <% if (tags && tags.length > 0) { %>
                        <div class="hint-text mt-1">
                            Popular tags:
                            <br>
                            <% tags.forEach(t => { %>
                                <span class="badge-suggestion"><%= t.name %></span>
                            <% }) %>
                        </div>
                    <% } %>
                </div>

                <!-- Swap vs Personal + Visibility -->
                <div class="row">
                    <!-- is_for_swap -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Is this item for swap? <span class="required">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_for_swap" id="swap_yes" value="yes">
                            <label class="form-check-label" for="swap_yes">
                                Yes, put this up for swap
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_for_swap" id="swap_no" value="no" checked>
                            <label class="form-check-label" for="swap_no">
                                No, personal wardrobe only
                            </label>
                        </div>
                        <div class="hint-text mt-1">
                            Items marked for swap will appear in the Swap tab and swapping flow.
                        </div>
                    </div>

                    <!-- is_public -->
                    <div class="col-md-6 mb-3">
                        <label class="form-label">Visibility</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_public" id="public_yes" value="yes" checked>
                            <label class="form-check-label" for="public_yes">
                                Public (visible to others)
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="is_public" id="public_no" value="no">
                            <label class="form-check-label" for="public_no">
                                Private (only you can see)
                            </label>
                        </div>
                        <div class="hint-text mt-1">
                            If you choose ‚ÄúSwap = Yes‚Äù, this item will automatically be set to Public.
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="mb-3">
                    <label class="form-label">Item Images <span class="hint-text">(Max 5MB each)</span></label>
                    <div class="row g-2">
                        <div class="col-md-4">
                            <input 
                                type="file" 
                                class="form-control" 
                                name="image1" 
                                accept="image/*"
                                onchange="validateImageSize(this)"
                            >
                            <div class="hint-text mt-1">Main image (recommended)</div>
                        </div>
                        <div class="col-md-4">
                            <input 
                                type="file" 
                                class="form-control" 
                                name="image2" 
                                accept="image/*"
                                onchange="validateImageSize(this)"
                            >
                            <div class="hint-text mt-1">Optional</div>
                        </div>
                        <div class="col-md-4">
                            <input 
                                type="file" 
                                class="form-control" 
                                name="image3" 
                                accept="image/*"
                                onchange="validateImageSize(this)"
                            >
                            <div class="hint-text mt-1">Optional</div>
                        </div>
                    </div>
                    <div id="imageSizeError" style="color: #e60000; font-size: 0.85rem; margin-top: 0.5rem; display: none;"></div>
                </div>

                <!-- Submit -->
                <div class="mt-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary-custom">
                        Save Item
                    </button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- Smart Tags Feature -->
<script>
  let suggestedTags = [];

  document.getElementById('suggestTagsBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    
    const title = document.getElementById('title')?.value || '';
    const description = document.getElementById('description')?.value || '';
    const category = document.getElementById('category')?.value || '';
    
    if (!title) {
      alert('Please enter an item title first');
      return;
    }
    
    const loadingSpan = document.getElementById('tagsLoadingIndicator');
    loadingSpan.style.display = 'inline';
    
    try {
      const response = await fetch('/api/ai/suggest-tags', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          itemTitle: title,
          itemDescription: description,
          itemCategory: category
        })
      });
      
      loadingSpan.style.display = 'none';
      
      if (!response.ok) {
        throw new Error('Failed to get suggestions');
      }
      
      const data = await response.json();
      
      if (data.success) {
        suggestedTags = data.suggestedTags;
        displaySuggestedTags();
      } else {
        alert('Unable to generate tag suggestions. Please add tags manually.');
      }
    } catch (error) {
      loadingSpan.style.display = 'none';
      console.error('Error:', error);
      alert('Error getting tag suggestions. Try again.');
    }
  });
  
  function displaySuggestedTags() {
    const listDiv = document.getElementById('suggestedTagsList');
    listDiv.innerHTML = '';
    
    suggestedTags.forEach(tag => {
      const tagEl = document.createElement('div');
      tagEl.className = 'suggested-tag';
      tagEl.textContent = tag;
      tagEl.style.cssText = `
        background: white;
        border: 2px solid #e60000;
        color: #e60000;
        padding: 0.4rem 0.8rem;
        border-radius: 999px;
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s;
      `;
      
      tagEl.addEventListener('click', () => {
        tagEl.classList.toggle('selected');
        if (tagEl.classList.contains('selected')) {
          tagEl.style.background = '#e60000';
          tagEl.style.color = 'white';
        } else {
          tagEl.style.background = 'white';
          tagEl.style.color = '#e60000';
        }
        
        // Add selected tags to input field
        const selectedTags = Array.from(document.querySelectorAll('.suggested-tag.selected'))
          .map(el => el.textContent);
        
        const tagsInput = document.getElementById('tags');
        if (selectedTags.length > 0) {
          tagsInput.value = selectedTags.join(', ');
        }
      });
      
      listDiv.appendChild(tagEl);
    });
  }
  
  // Show suggestions section when user starts typing title
  const titleInput = document.getElementById('title');
  if (titleInput) {
    titleInput.addEventListener('input', () => {
      document.getElementById('tagSuggestionsSection').style.display = 
        titleInput.value.length > 0 ? 'block' : 'none';
    });
  }

  // File size validation (5MB max)
  function validateImageSize(input) {
    const maxSizeMB = 5;
    const maxSizeBytes = maxSizeMB * 1024 * 1024;
    const errorDiv = document.getElementById('imageSizeError');
    
    if (input.files && input.files[0]) {
      const file = input.files[0];
      
      if (file.size > maxSizeBytes) {
        errorDiv.textContent = `File "${file.name}" is too large (${(file.size / 1024 / 1024).toFixed(1)}MB). Max size is ${maxSizeMB}MB.`;
        errorDiv.style.display = 'block';
        input.value = ''; // Clear the input
        return false;
      } else if (!file.type.startsWith('image/')) {
        errorDiv.textContent = `File "${file.name}" is not a valid image format. Please upload JPG, PNG, GIF, or WebP.`;
        errorDiv.style.display = 'block';
        input.value = ''; // Clear the input
        return false;
      } else {
        errorDiv.style.display = 'none'; // Clear any previous errors
      }
    }
    
    return true;
  }

  // Update tag suggestion visibility
  function updateTagSuggestionVisibility() {
    const titleInput = document.getElementById('title');
    const suggestionsSection = document.getElementById('tagSuggestionsSection');
    suggestionsSection.style.display = titleInput.value.length > 0 ? 'block' : 'none';
  }

  // Form submission validation
  document.querySelector('form').addEventListener('submit', (e) => {
    const files = ['image1', 'image2', 'image3'];
    let hasError = false;
    
    for (let fieldName of files) {
      const input = document.querySelector(`input[name="${fieldName}"]`);
      if (input && input.files && input.files[0]) {
        if (!validateImageSize(input)) {
          hasError = true;
        }
      }
    }
    
    if (hasError) {
      e.preventDefault();
      return false;
    }
    
    // Require at least one tag
    const tagsInput = document.getElementById('tags').value.trim();
    if (!tagsInput) {
      alert('Please add at least one tag to your item. You can use AI suggestions or add your own!');
      e.preventDefault();
      return false;
    }
  });
</script>
</body>
</html>
