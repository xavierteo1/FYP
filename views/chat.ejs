<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Chat</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <!-- Global Design System -->
  <link href="/css/global-design.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- PayPal (only used when paymentSplit confirmed & user must pay) -->
  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= paypalCurrency %>&intent=capture"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --muted:#6c757d;
      --border:#e9ecef;
      --shadow:0 10px 30px rgba(0,0,0,.07);

      --me:#0d6efd;
      --other:#111827;
      --me-bubble:#e8f1ff;
      --other-bubble:#f2f4f7;

      --success-bg:#e8fff3;
      --success-bd:#b9f3d1;
      --warn-bg:#fff7e6;
      --warn-bd:#ffe2a6;
      --info-bg:#eef2ff;
      --info-bd:#c7d2fe;
      --danger-bg:#ffe9e9;
      --danger-bd:#ffc0c0;
    }

    body{
      background:var(--bg);
      color:#0f172a;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    .topcard{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:var(--shadow);
    }

    .header-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:16px 16px 10px 16px;
      border-bottom:1px solid var(--border);
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }

    .avatar{
      width:44px;height:44px;border-radius:14px;
      background:linear-gradient(135deg, #dbeafe, #fce7f3);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;
      color:#0f172a;
      flex:0 0 auto;
      border:1px solid var(--border);
    }

    .title-wrap{min-width:0;}
    .chat-title{
      font-weight:800;
      font-size:16px;
      margin:0;
      line-height:1.1;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chat-sub{
      font-size:12px;
      color:var(--muted);
      margin:2px 0 0 0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .status-area{
      padding:12px 16px 6px 16px;
    }

    .status-banner{
      border-radius:14px;
      padding:10px 12px;
      border:1px solid var(--border);
      background:#fff;
    }
    .status-banner.ok{ background:var(--success-bg); border-color:var(--success-bd); }
    .status-banner.warn{ background:var(--warn-bg); border-color:var(--warn-bd); }
    .status-banner.info{ background:var(--info-bg); border-color:var(--info-bd); }
    .status-banner.danger{ background:var(--danger-bg); border-color:var(--danger-bd); }

    .status-title{
      font-weight:800;
      font-size:13px;
      margin-bottom:2px;
    }
    .status-sub{
      font-size:12px;
      color:#334155;
      margin:0;
    }
    .mono-badge{
      font-size:11px;
      border:1px dashed rgba(15,23,42,.25);
      padding:2px 8px;
      border-radius:999px;
      color:#0f172a;
      background:rgba(255,255,255,.7);
    }

    .items-row{
      padding:0 16px 12px 16px;
    }
    .item-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      height:100%;
    }
    .item-img{
      width:100%;
      height:160px;
      object-fit:cover;
      background:#f1f5f9;
    }
    .item-body{
      padding:10px 12px 12px;
    }
    .item-title{
      font-weight:800;
      margin:0;
      font-size:13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .item-owner{
      margin:2px 0 0;
      font-size:11px;
      color:var(--muted);
    }

    .messages-box{
      height:420px;
      overflow:auto;
      padding:14px 16px;
      border-top:1px solid var(--border);
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.7));
    }

    .msg-row{
      display:flex;
      margin-bottom:10px;
    }
    .msg-row.me{ justify-content:flex-end; }
    .msg-row.other{ justify-content:flex-start; }

    .bubble{
      max-width:74%;
      border-radius:18px;
      padding:10px 12px 8px;
      border:1px solid var(--border);
      box-shadow:0 2px 10px rgba(0,0,0,.04);
    }
    .bubble.me{
      background:var(--me-bubble);
      border-color:#cfe2ff;
    }
    .bubble.other{
      background:var(--other-bubble);
      border-color:#e5e7eb;
    }

    .bubble .meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-bottom:4px;
    }
    .meta .name{
      font-weight:800;
      font-size:12px;
    }
    .meta .time{
      font-size:11px;
      color:var(--muted);
      white-space:nowrap;
    }
    .bubble .text{
      margin:0;
      font-size:13px;
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
    }

    /* System messages */
    .sys-row{
      display:flex;
      justify-content:center;
      margin:14px 0;
    }
    .sys-pill{
      font-size:11px;
      color:#334155;
      border:1px dashed rgba(15,23,42,.25);
      background:rgba(255,255,255,.85);
      padding:6px 10px;
      border-radius:999px;
      max-width:90%;
      text-align:center;
    }

    .composer{
      padding:12px 16px 16px;
      display:flex;
      gap:10px;
      align-items:flex-end;
    }

    .composer textarea{
      resize:none;
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,.04);
      padding:10px 12px;
      font-size:13px;
      min-height:44px;
      max-height:120px;
    }

    .send-btn{
      border-radius:14px;
      font-weight:800;
      padding:10px 14px;
      box-shadow:0 8px 18px rgba(13,110,253,.18);
    }

    /* Command Drawer (Tinder-like) */
    .cmd-drawer{
      position:absolute;
      left:16px;
      right:16px;
      bottom:78px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:var(--shadow);
      padding:8px;
      display:none;
      z-index:20;
    }
    .cmd-item{
      padding:10px 10px;
      border-radius:12px;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    .cmd-item:hover{
      background:#f8fafc;
    }
    .cmd-item.active{
      background:#eef2ff;
      border:1px solid #c7d2fe;
    }
    .cmd-left{
      min-width:0;
    }
    .cmd-name{
      font-weight:900;
      font-size:13px;
      margin:0;
    }
    .cmd-desc{
      font-size:11px;
      color:var(--muted);
      margin:1px 0 0 0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .cmd-pill{
      font-size:11px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      color:#0f172a;
      background:#fff;
      white-space:nowrap;
    }
    .force-locked .btn-close{display:none !important;}

    /* Modal tweaks */
    .modal-content{
      border-radius:18px;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
    }
    .modal-header{
      border-bottom:1px solid var(--border);
    }
    .modal-footer{
      border-top:1px solid var(--border);
    }

    .tiny{
      font-size:12px;
      color:var(--muted);
    }
    /* When a modal is forced for the responder, hide dismiss controls */
    .force-locked .btn-close{display:none !important;}
    .force-locked [data-bs-dismiss="modal"]{display:none !important;}

    /* Frutiger Metro Dynamic Background */
    body {
        background: linear-gradient(45deg, #E8F4F8, #F0E8F8, #F8F0E8, #E8F8F0, #F8F0F0, #E8F4F8);
        background-size: 400% 400%;
        animation: metro-flow 30s ease infinite;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, rgba(0, 120, 215, 0.12) 0%, transparent 30%, transparent 70%, rgba(0, 120, 215, 0.12) 100%),
            linear-gradient(180deg, rgba(255, 140, 0, 0.08) 0%, transparent 40%, transparent 60%, rgba(255, 140, 0, 0.08) 100%),
            linear-gradient(45deg, rgba(107, 142, 35, 0.1) 0%, transparent 50%, transparent 50%, rgba(107, 142, 35, 0.1) 100%);
        animation: metro-grid 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 0%, rgba(0, 120, 215, 0.05) 25%, rgba(0, 120, 215, 0.05) 75%, transparent 100%),
            linear-gradient(0deg, transparent 0%, rgba(255, 140, 0, 0.04) 50%, transparent 100%);
        background-size: 200% 100%, 100% 200%;
        animation: metro-slide 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes metro-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes metro-grid {
        0%, 100% { transform: scale(1) translateY(0); filter: brightness(1); }
        25% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
        50% { transform: scale(1.01) translateY(-10px); filter: brightness(1.05); }
        75% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
    }

    @keyframes metro-slide {
        0%, 100% { background-position: 0% 0%, 0% 0%; }
        50% { background-position: 100% 0%, 0% 100%; }
    }

    body > * {
        position: relative;
        z-index: 1;
    }

  </style>
</head>
<body>
  <div class="container py-4">
    <div class="topcard">

      <!-- Header -->
      <div class="header-row">
        <div class="header-left">
          <div class="avatar">
            <%= (chat.user1_username || 'U')[0].toUpperCase() %><%= (chat.user2_username || 'U')[0].toUpperCase() %>
          </div>
          <div class="title-wrap">
            <p class="chat-title mb-0">
              <%= chat.user1_username %> <span class="text-secondary">×</span> <%= chat.user2_username %>
            </p>
            <p class="chat-sub">
              Type “/” to open commands • <span id="updatedLabel">Updated just now</span>
            </p>
          </div>
        </div>
        <div class="d-flex gap-2">
          <a href="/swap/matches" class="btn btn-outline-secondary btn-sm rounded-4">Back</a>
        </div>
      </div>

      <!-- Status / Progress -->
      <div id="statusArea" class="status-area">
        <% const locked = Number(chat.details_locked) === 1; %>

        <% const meIsUser1 = String(user.user_id) === String(chat.user1_id); %>
        <% const otherName = meIsUser1 ? chat.user2_username : chat.user1_username; %>

        <% const openModalSafe = openModal || ''; %>

        <% const pendingSwapMethodSafe = pendingSwapMethod || null; %>
        <% const pendingMeetupLocationSafe = pendingMeetupLocation || null; %>
        <% const pendingPaymentSplitSafe = pendingPaymentSplit || null; %>
        <% const pendingScheduledTimeSafe = pendingScheduledTime || null; %>

        <% const pickupDeliveryRequestsSafe = pickupDeliveryRequests || []; %>

        <% const feeLegU1 = pickupDeliveryRequestsSafe.find(r => r.leg === 'u1_to_u2'); %>
        <% const feeLegU2 = pickupDeliveryRequestsSafe.find(r => r.leg === 'u2_to_u1'); %>

        <!-- Swap method -->
        <% if (!locked && !chat.swap_method) { %>
          <% if (pendingSwapMethodSafe) { %>
            <% const isProposer = String(pendingSwapMethodSafe.proposed_by_user_id) === String(user.user_id); %>
            <% const nice = pendingSwapMethodSafe.proposed_value === 'sahm' ? 'SwapMates' : 'Meetup'; %>

            <% if (isProposer) { %>
              <div class="status-banner info">
                <div class="status-title">Waiting for <%= otherName %> to confirm swap method</div>
                <div class="status-sub">
                  You proposed: <b><%= nice %></b>
                </div>
              </div>
            <% } else { %>
              <div class="status-banner warn">
                <div class="status-title"><%= pendingSwapMethodSafe.proposed_by_username %> proposed a swap method</div>
                <div class="status-sub">
                  Proposed: <b><%= nice %></b> • Type <b>/confirmSwapMethod</b> to respond.
                </div>
              </div>
            <% } %>
          <% } else { %>
            <div class="status-banner info">
              <div class="status-title">Swap method not decided</div>
              <div class="status-sub">Type <b>/confirmSwapMethod</b> to propose.</div>
            </div>
          <% } %>
        <% } %>

        <!-- Meetup location -->
        <% if (!locked && chat.swap_method === 'meetup') { %>
          <% if (!chat.meetup_location_id) { %>
            <% if (pendingMeetupLocationSafe) { %>
              <% const isProposer = String(pendingMeetupLocationSafe.proposed_by_user_id) === String(user.user_id); %>
              <% if (isProposer) { %>
                <div class="status-banner info mt-2">
                  <div class="status-title">Waiting for <%= otherName %> to confirm meetup location</div>
                  <div class="status-sub">
                    You proposed: <b><%= pendingMeetupLocationSafe.location_label || ('Location #' + pendingMeetupLocationSafe.proposed_value) %></b>
                  </div>
                </div>
              <% } else { %>
                <div class="status-banner warn mt-2">
                  <div class="status-title"><%= pendingMeetupLocationSafe.proposed_by_username %> proposed a meetup location</div>
                  <div class="status-sub">
                    Proposed: <b><%= pendingMeetupLocationSafe.location_label || ('Location #' + pendingMeetupLocationSafe.proposed_value) %></b> • Type <b>/confirmLocation</b> to respond.
                  </div>
                </div>
              <% } %>
            <% } else { %>
              <div class="status-banner info mt-2">
                <div class="status-title">Meetup location not decided</div>
                <div class="status-sub">Type <b>/confirmLocation</b> to propose a meetup location.</div>
              </div>
            <% } %>
          <% } else { %>
            <div class="status-banner ok mt-2">
              <div class="status-title">Meetup location confirmed</div>
              <div class="status-sub">
                <b><%= (meetupLocation && meetupLocation.label) ? meetupLocation.label : ('Location #' + chat.meetup_location_id) %></b>
              </div>
            </div>
          <% } %>
        <% } %>

        <!-- SwapMates addresses -->
        <% if (!locked && chat.swap_method === 'sahm') { %>
          <div class="status-banner info mt-2">
            <div class="status-title">SwapMates delivery selected</div>
            <div class="status-sub">
              <% if (!mySahmAddress) { %>
                You have not set your pickup/drop-off address yet • Type <b>/confirmLocation</b>
              <% } else { %>
                Your address: <b><%= mySahmAddress.label %></b>
              <% } %>
              <% if (otherSahmAddress) { %>
                • <%= otherName %> address: <b><%= otherSahmAddress.label %></b>
              <% } %>
            </div>
          </div>

          <% if (typeof sahmFeeTotal === 'number') { %>
            <div class="status-banner info mt-2">
              <div class="status-title">Estimated delivery fee</div>
              <div class="status-sub">
                Total fee: <b>$<%= sahmFeeTotal.toFixed(2) %></b>
                <% if (feeLegU1 && feeLegU2) { %>
                  • <span class="mono-badge">U1→U2: $<%= Number(feeLegU1.delivery_fee || 0).toFixed(2) %></span>
                  <span class="mono-badge">U2→U1: $<%= Number(feeLegU2.delivery_fee || 0).toFixed(2) %></span>
                <% } %>
              </div>
            </div>
          <% } %>

          <!-- Payment split -->
          <% if (!chat.payment_split) { %>
            <% if (pendingPaymentSplitSafe) { %>
              <% const isProposer = String(pendingPaymentSplitSafe.proposed_by_user_id) === String(user.user_id); %>
              <% const niceSplit = (v) => {
                if (v === 'split') return 'Split evenly';
                if (v === 'user1_pays_all') return (meIsUser1 ? 'You pay all' : chat.user1_username + ' pays all');
                if (v === 'user2_pays_all') return (!meIsUser1 ? 'You pay all' : chat.user2_username + ' pays all');
                return v;
              }; %>

              <% if (isProposer) { %>
                <div class="status-banner info mt-2">
                  <div class="status-title">Waiting for <%= otherName %> to confirm payment split</div>
                  <div class="status-sub">You proposed: <b><%= niceSplit(pendingPaymentSplitSafe.proposed_value) %></b></div>
                </div>
              <% } else { %>
                <div class="status-banner warn mt-2">
                  <div class="status-title"><%= pendingPaymentSplitSafe.proposed_by_username %> proposed a payment split</div>
                  <div class="status-sub">
                    Proposed: <b><%= niceSplit(pendingPaymentSplitSafe.proposed_value) %></b> • Type <b>/confirmPaymentSplit</b> to respond.
                  </div>
                </div>
              <% } %>
            <% } else { %>
              <div class="status-banner info mt-2">
                <div class="status-title">Payment split not decided</div>
                <div class="status-sub">Type <b>/confirmPaymentSplit</b> to propose.</div>
              </div>
            <% } %>
          <% } else { %>
            <div class="status-banner ok mt-2">
              <div class="status-title">Payment split confirmed</div>
              <div class="status-sub">
                <% if (chat.payment_split === 'split') { %>
                  Split evenly
                <% } else if (chat.payment_split === 'user1_pays_all') { %>
                  <%= chat.user1_username %> pays all
                <% } else if (chat.payment_split === 'user2_pays_all') { %>
                  <%= chat.user2_username %> pays all
                <% } else { %>
                  <%= chat.payment_split %>
                <% } %>
              </div>
            </div>

            <% if (chat.swap_method === 'sahm') { %>
              <div class="status-banner info mt-2">
                <div class="status-title">Payment status</div>
                <div class="status-sub">
                  <% if (myPay && myPay.required) { %>
                    You: <b>$<%= Number(myPay.amount || 0).toFixed(2) %></b>
                    • <span class="mono-badge"><%= myPay.status ? myPay.status : 'pending' %></span>
                  <% } else { %>
                    You: <span class="mono-badge">no payment required</span>
                  <% } %>

                  •
                  <% if (otherPay && otherPay.required) { %>
                    <%= otherName %>: <b>$<%= Number(otherPay.amount || 0).toFixed(2) %></b>
                    • <span class="mono-badge"><%= otherPay.status ? otherPay.status : 'pending' %></span>
                  <% } else { %>
                    <%= otherName %>: <span class="mono-badge">no payment required</span>
                  <% } %>

                  <% if (paymentComplete) { %>
                    <div class="mt-2"><span class="mono-badge">✅ Payment complete</span></div>
                  <% } else { %>
                    <div class="mt-2"><span class="mono-badge">⏳ Waiting for required payments</span></div>
                  <% } %>
                </div>
              </div>
            <% } %>
          <% } %>
        <% } %>

        <!-- Scheduled time -->
        <% if (!locked) { %>
          <% const canSchedule = (chat.swap_method === 'meetup' && chat.meetup_location_id) || (chat.swap_method === 'sahm' && chat.payment_split && paymentComplete); %>

          <% if (canSchedule) { %>
            <% if (!chat.scheduled_time) { %>
              <% if (pendingScheduledTimeSafe) { %>
                <% const isProposer = String(pendingScheduledTimeSafe.proposed_by_user_id) === String(user.user_id); %>

                <% if (isProposer) { %>
                  <div class="status-banner info mt-2">
                    <div class="status-title">Waiting for <%= otherName %> to confirm time</div>
                    <div class="status-sub">
                      You proposed: <b><span class="msg-time" data-ts="<%= pendingScheduledTimeSafe.proposed_value %>"></span></b>
                    </div>
                  </div>
                <% } else { %>
                  <div class="status-banner warn mt-2">
                    <div class="status-title"><%= pendingScheduledTimeSafe.proposed_by_username %> proposed a time</div>
                    <div class="status-sub">
                      Proposed: <b><span class="msg-time" data-ts="<%= pendingScheduledTimeSafe.proposed_value %>"></span></b>
                      • Type <b>/confirmTime</b> to respond.
                    </div>
                  </div>
                <% } %>
              <% } else { %>
                <div class="status-banner info mt-2">
                  <div class="status-title">Time not decided</div>
                  <div class="status-sub">Type <b>/confirmTime</b> to propose a time.</div>
                </div>
              <% } %>
            <% } else { %>
              <div class="status-banner ok mt-2">
                <div class="status-title">Time confirmed</div>
                <div class="status-sub">
                  <b><span class="msg-time" data-ts="<%= chat.scheduled_time %>"></span></b>
                </div>
              </div>
            <% } %>
          <% } else { %>
            <% if (chat.swap_method) { %>
              <div class="status-banner info mt-2">
                <div class="status-title">Time scheduling locked until prerequisites complete</div>
                <div class="status-sub">
                  <% if (chat.swap_method === 'meetup') { %>
                    Confirm meetup location first.
                  <% } else { %>
                    Confirm payment split and complete payment first.
                  <% } %>
                </div>
              </div>
            <% } %>
          <% } %>
        <% } %>

        <!-- If locked but scheduled_time exists (safety) -->
        <% if (locked && chat.scheduled_time) { %>
          <div class="status-banner ok mt-2">
            <div class="status-title">Details locked</div>
            <div class="status-sub">
              Confirmed time: <b><span class="msg-time" data-ts="<%= chat.scheduled_time %>"></span></b>
            </div>
          </div>
        <% } %>


        <!-- SwapMates delivery status (after time is confirmed / locked) -->
        <% if (chat.swap_method === 'sahm' && chat.scheduled_time && Number(chat.details_locked) === 1) { %>
          <%
            const legs = (pickupDeliveryRequestsSafe || []);
            const anyAccepted = legs.some(r => r && r.sahm_user_id);
            const allCompleted = legs.length > 0 && legs.every(r => String(r.status) === 'completed');
            const anyInProgress = legs.some(r => String(r.status) === 'in_progress');
            const firstSahm = legs.find(r => r && r.sahm_user_id) || null;
            const sahmName = firstSahm ? (firstSahm.sahm_username || 'SwapMates') : null;

            const labelOf = (locId, label) => (label ? label : (`Location #${locId}`));
            const lineFor = (r) => {
              const pick = labelOf(r.pickup_location_id, r.pickup_label);
              const drop = labelOf(r.dropoff_location_id, r.dropoff_label);
              if (String(r.status) === 'accepted') return `Accepted • ${pick} → ${drop}`;
              if (String(r.status) === 'in_progress') return `Picked up • ${pick} → Delivering to ${drop}`;
              if (String(r.status) === 'completed') return `Completed • ${pick} → ${drop}`;
              if (String(r.status) === 'cancelled') return `Cancelled • ${pick} → ${drop}`;
              return `Pending • ${pick} → ${drop}`;
            };
          %>

          <% if (!anyAccepted) { %>
            <div class="status-banner warn mt-2" id="sahmNoAvailableBanner">
              <div class="status-title">No SwapMates member is available at this timing (for now)</div>
              <div class="status-sub">
                Scheduled time: <b><span class="msg-time" data-ts="<%= chat.scheduled_time %>"></span></b>.
                If nobody accepts, you can reschedule by typing <b>/confirmTime</b>.
                <span id="sahm30MinHint" style="display:none;"><br/><b>30 mins left</b>: consider rescheduling so a SwapMates member can match your timing.</span>
              </div>
            </div>
          <% } else { %>
            <div class="status-banner <%= allCompleted ? 'ok' : (anyInProgress ? 'warn' : 'info') %> mt-2">
              <div class="status-title">
                SAHM <%= allCompleted ? 'completed the order' : (anyInProgress ? 'is delivering now' : 'accepted your order') %>
              </div>
              <div class="status-sub">
                <% if (sahmName) { %>Assigned SAHM: <b><%= sahmName %></b><br/><% } %>
                Starts at: <b><span class="msg-time" data-ts="<%= chat.scheduled_time %>"></span></b>

                <% if (legs.length) { %>
                  <div class="mt-2">
                    <% legs.forEach(r => { %>
                      <div class="mono-badge me-2 mb-2" style="display:inline-block;"><%= lineFor(r) %></div>
                    <% }) %>
                  </div>
                <% } %>
              </div>
            </div>
          <% } %>
        <% } %>

      </div>

      <!-- Items summary -->
      <div class="mt-3">
        <div class="row g-3 items-row">
          <div class="col-md-6">
            <div class="item-card">
              <img class="item-img" src="<%= chat.item1_image || '/images/placeholder.png' %>" alt="Item 1"/>
              <div class="item-body">
                <p class="item-title"><%= chat.item1_title %></p>
                <p class="item-owner">Owner: <%= chat.user1_username %></p>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="item-card">
              <img class="item-img" src="<%= chat.item2_image || '/images/placeholder.png' %>" alt="Item 2"/>
              <div class="item-body">
                <p class="item-title"><%= chat.item2_title %></p>
                <p class="item-owner">Owner: <%= chat.user2_username %></p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Review Button (if swap is completed) -->
      <% if (chat.status === 'completed') { %>
        <div class="mt-3">
          <button class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.5rem 1.2rem;" data-bs-toggle="modal" data-bs-target="#reviewModal">
            Leave a Review
          </button>
        </div>
      <% } %>

      <!-- Messages -->
      <div id="messagesBox" class="messages-box">
        <% (messages || []).forEach(m => { %>
          <% const isSystem = (m.message_text || '').startsWith('[SYSTEM]'); %>
          <% if (isSystem) { %>
            <div class="sys-row">
              <div class="sys-pill"><%= (m.message_text || '').replace('[SYSTEM]', '').trim() %></div>
            </div>
          <% } else { %>
            <% const isMe = String(m.sender_user_id) === String(user.user_id); %>
            <div class="msg-row <%= isMe ? 'me' : 'other' %>">
              <div class="bubble <%= isMe ? 'me' : 'other' %>">
                <div class="meta">
                  <span class="name"><%= isMe ? 'You' : m.sender_username %></span>
                  <span class="time msg-time" data-ts="<%= m.created_at %>"></span>
                </div>
                <p class="text"><%= m.message_text %></p>
              </div>
            </div>
          <% } %>
        <% }) %>
      </div>

      <!-- Composer -->
      <div class="position-relative">
        <div id="cmdDrawer" class="cmd-drawer"></div>

        <form class="composer" method="POST" action="/chats/<%= chat.chat_id %>/messages">
          <textarea id="msgInput" name="message_text" class="form-control" placeholder='Type a message… (type “/” for commands)'></textarea>
          <button class="btn btn-primary send-btn" type="submit">Send</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <!-- Swap method modal -->
  <div class="modal fade" id="swapMethodModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Confirm Swap Method</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="tiny mb-2">Choose how you want to complete this swap.</p>

                    <% if (!pendingSwapMethodSafe) { %>
<form method="POST" action="/chats/<%= chat.chat_id %>/confirm/swap-method" class="d-grid gap-2">
            <button class="btn btn-outline-primary rounded-4" name="swap_method" value="meetup" type="submit">Meetup</button>
            <button class="btn btn-outline-primary rounded-4" name="swap_method" value="sahm" type="submit">SwapMates Delivery</button>
          </form>
          <% } %>

                    <% if (pendingSwapMethodSafe) { %>
            <% const isProposer = String(pendingSwapMethodSafe.proposed_by_user_id) === String(user.user_id); %>
            <hr/>
            <div class="small">
              Pending: <b><%= pendingSwapMethodSafe.proposed_value === 'sahm' ? 'SwapMates' : 'Meetup' %></b>

              <% if (!isProposer) { %>
                <div class="mt-2 d-flex gap-2 flex-wrap">
                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/swap-method/respond" class="d-inline">
                    <input type="hidden" name="action" value="accept"/>
                    <button class="btn btn-success btn-sm rounded-4">Accept</button>
                  </form>

                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/swap-method/counter" class="d-inline">
                    <input type="hidden" name="counter_value" value="<%= pendingSwapMethodSafe.proposed_value === 'sahm' ? 'meetup' : 'sahm' %>"/>
                    <button class="btn btn-outline-secondary btn-sm rounded-4">Counter</button>
                  </form>

                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/swap-method/respond" class="d-inline">
                    <input type="hidden" name="action" value="reject"/>
                    <button class="btn btn-outline-danger btn-sm rounded-4">Reject</button>
                  </form>
                </div>
                <div class="tiny mt-2">Only respond here. No need to re-propose — Accept, Counter, or Reject.</div>
              <% } else { %>
                <div class="tiny mt-2">You proposed this. Waiting for the other person to respond.</div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Location modal -->
  <div class="modal fade" id="locationModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Confirm Location</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <% if (chat.swap_method === 'meetup') { %>
            <p class="tiny mb-2">Propose a meetup location (both must agree).</p>

                        <% if (!pendingMeetupLocationSafe) { %>
<form method="POST" action="/chats/<%= chat.chat_id %>/confirm/meetup-location" class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label tiny">Choose your saved location</label>
                <select class="form-select rounded-4" name="location_id" required>
                  <option value="">Select…</option>
                  <% (locations || []).forEach(l => { %>
                    <option value="<%= l.location_id %>"><%= l.label %> (<%= l.postal_code %>)</option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4 d-grid">
                <button class="btn btn-primary rounded-4" type="submit">Propose</button>
              </div>
            </form>
            <% } %>

                        <% if (pendingMeetupLocationSafe) { %>
              <% const isProposer = String(pendingMeetupLocationSafe.proposed_by_user_id) === String(user.user_id); %>
              <hr/>
              <div class="small">
                Pending: <b><%= pendingMeetupLocationSafe.location_label || ('Location #' + pendingMeetupLocationSafe.proposed_value) %></b>

                <% if (!isProposer) { %>
                  <div class="mt-2 d-flex gap-2 flex-wrap">
                    <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/meetup-location/respond" class="d-inline">
                      <input type="hidden" name="action" value="accept"/>
                      <button class="btn btn-success btn-sm rounded-4">Accept</button>
                    </form>

                    <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/meetup-location/counter" class="d-inline">
                      <div class="d-flex gap-2 align-items-center flex-wrap">
                        <select class="form-select form-select-sm rounded-4" name="counter_location_id" required style="max-width:240px">
                          <option value="">Counter location…</option>
                          <% (locations || []).forEach(l => { %>
                            <option value="<%= l.location_id %>"><%= l.label %> (<%= l.postal_code %>)</option>
                          <% }) %>
                        </select>
                        <button class="btn btn-outline-secondary btn-sm rounded-4" type="submit">Counter</button>
                      </div>
                    </form>

                    <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/meetup-location/respond" class="d-inline">
                      <input type="hidden" name="action" value="reject"/>
                      <button class="btn btn-outline-danger btn-sm rounded-4">Reject</button>
                    </form>
                  </div>
                  <div class="tiny mt-2">Only respond here. No need to re-propose — Accept, Counter, or Reject.</div>
                <% } else { %>
                  <div class="tiny mt-2">You proposed this. Waiting for the other person to respond.</div>
                <% } %>
              </div>
            <% } %>

          <% } else if (chat.swap_method === 'sahm') { %>

            <p class="tiny mb-2">Choose your delivery address (each person sets their own address).</p>

            <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/sahm-address" class="row g-2 align-items-end">
              <div class="col-md-8">
                <label class="form-label tiny">Choose your saved location</label>
                <select class="form-select rounded-4" name="location_id" required>
                  <option value="">Select…</option>
                  <% (locations || []).forEach(l => { %>
                    <option value="<%= l.location_id %>"><%= l.label %> (<%= l.postal_code %>)</option>
                  <% }) %>
                </select>
              </div>
              <div class="col-md-4 d-grid">
                <button class="btn btn-primary rounded-4" type="submit">Save</button>
              </div>
            </form>

            <hr class="my-3"/>

            <p class="tiny mb-2">Add a new location (optional).</p>
            <form method="POST" action="/chats/<%= chat.chat_id %>/locations/add" class="row g-2">
              <div class="col-md-4">
                <input class="form-control rounded-4" name="label" placeholder="Label (e.g. Woodlands MRT)" required />
              </div>
              <div class="col-md-4">
                <input class="form-control rounded-4" name="postal_code" placeholder="Postal Code" required />
              </div>
              <div class="col-md-4">
                <input class="form-control rounded-4" name="address_line" placeholder="Address line" required />
              </div>
              <div class="col-md-6">
                <input class="form-control rounded-4" name="city" placeholder="City" />
              </div>
              <div class="col-md-3">
                <input class="form-control rounded-4" name="latitude" placeholder="Lat (optional)" />
              </div>
              <div class="col-md-3">
                <input class="form-control rounded-4" name="longitude" placeholder="Lng (optional)" />
              </div>
              <div class="col-12 d-grid">
                <button class="btn btn-outline-secondary rounded-4" type="submit">Add Location</button>
              </div>
            </form>
          <% } else { %>
            <div class="alert alert-info rounded-4 mb-0">Pick a swap method first.</div>
          <% } %>

        </div>
      </div>
    </div>
  </div>

  <!-- Payment Split modal -->
  <div class="modal fade" id="paymentSplitModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Confirm Payment Split</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">

          <% if (chat.swap_method !== 'sahm') { %>
            <div class="alert alert-info rounded-4 mb-0">Payment split is only for SwapMates Delivery. Choose SwapMates as your swap method first.</div>
          <% } else { %>

          <p class="tiny mb-2">Choose how to split the SAHM delivery fee.</p>

                    <% if (!chat.payment_split && !pendingPaymentSplitSafe) { %>
<form method="POST" action="/chats/<%= chat.chat_id %>/confirm/payment-split" class="d-grid gap-2">
            <button class="btn btn-outline-primary rounded-4" name="choice" value="split" type="submit">Split</button>

            <% if (meIsUser1) { %>
              <button class="btn btn-outline-primary rounded-4" name="choice" value="i_pay" type="submit">I Pay</button>
            <% } else { %>
              <button class="btn btn-outline-primary rounded-4" name="choice" value="i_pay" type="submit">I Pay</button>
            <% } %>
          </form>
          <% } %>

<% if (pendingPaymentSplitSafe) { %>
  <%
    const isPaymentSplitProposer = String(pendingPaymentSplitSafe.proposed_by_user_id) === String(user.user_id);
    const isPaymentSplitReceiver =
      pendingPaymentSplitSafe.proposed_to_user_id &&
      Number(pendingPaymentSplitSafe.proposed_to_user_id) === Number(user.user_id);

    const pv = String(pendingPaymentSplitSafe.proposed_value || '');

    // ✅ Show ONE meaningful counter offer (the "opposite" of current proposal)
    let counterChoice = null;  // 'split' | 'i_pay'
    let counterLabel = '';

    if (pv === 'split_evenly') {
      counterChoice = 'i_pay';
      counterLabel = 'Counter: I Pay All';
    } else if (pv === 'user1_pays_all' || pv === 'user2_pays_all') {
      counterChoice = 'split';
      counterLabel = 'Counter: Split Evenly';
    } else {
      // fallback if unknown
      counterChoice = 'i_pay';
      counterLabel = 'Counter: I Pay All';
    }
  %>

  <hr/>
  <div class="small">
    Pending:
    <b>
      <% if (pv === 'split_evenly') { %>
        Split evenly
      <% } else if (pv === 'user1_pays_all') { %>
        <%= chat.user1_username %> pays all
      <% } else if (pv === 'user2_pays_all') { %>
        <%= chat.user2_username %> pays all
      <% } else { %>
        <%= pendingPaymentSplitSafe.proposed_value %>
      <% } %>
    </b>

    <% if (isPaymentSplitReceiver && !isPaymentSplitProposer) { %>
      <div class="mt-2 d-flex gap-2 flex-wrap">
        <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/payment-split/respond" class="d-inline">
          <input type="hidden" name="action" value="accept"/>
          <button class="btn btn-success btn-sm rounded-4">Accept</button>
        </form>

        <!-- ✅ dynamic opposite-counter -->
        <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/payment-split/counter" class="d-inline">
          <input type="hidden" name="choice" value="<%= counterChoice %>"/>
          <button class="btn btn-outline-secondary btn-sm rounded-4"><%= counterLabel %></button>
        </form>

        <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/payment-split/respond" class="d-inline">
          <input type="hidden" name="action" value="reject"/>
          <button class="btn btn-outline-danger btn-sm rounded-4">Reject</button>
        </form>
      </div>

      <div class="tiny mt-2">
        Only respond here. During a pending offer, proposing new options is hidden.
      </div>
    <% } else { %>
      <div class="tiny mt-2">You proposed this. Waiting for the other person to respond.</div>
    <% } %>
  </div>
<% } %>


<% if (chat.payment_split && !paymentComplete) { %>
            <hr/>
            <div class="alert alert-warning rounded-4 mb-0">
              Payment is required before time can be confirmed.
            </div>
          <% } %>

          <% if (chat.payment_split && myPay && myPay.required && myPay.status !== 'captured') { %>
            <hr/>
            <div class="small">
              <div class="fw-bold mb-1">Your payment required: $<%= Number(myPay.amount || 0).toFixed(2) %></div>

              <!-- OTP gate (after payment split confirmed, before PayPal) -->
              <div id="paymentOtpBlock" class="border rounded-4 p-3 mb-3">
                <div class="fw-bold mb-1">Email OTP required</div>
                <div class="tiny mb-2">For security, verify an OTP sent to your account email before paying.</div>

                <div id="otpStatus" class="tiny text-muted mb-2">Checking OTP status…</div>

                <div class="d-flex gap-2 flex-wrap align-items-center">
                  <button id="btnSendOtp" type="button" class="btn btn-outline-primary btn-sm rounded-4">Send OTP</button>
                  <input id="otpCodeInput" type="text" class="form-control form-control-sm rounded-4" placeholder="Enter OTP" style="max-width:180px" />
                  <button id="btnVerifyOtp" type="button" class="btn btn-primary btn-sm rounded-4">Verify</button>
                </div>
              </div>

              <div id="paypalBlock" style="display:none;">
                <div id="paypalButtons"></div>
                <div class="tiny mt-2">This modal will not close until payment is captured.</div>
              </div>
            </div>
          <% } %>

          <% } %>

        </div>
      </div>
    </div>
  </div>

  <!-- Time modal -->
  <div class="modal fade" id="timeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Confirm Time</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="tiny mb-2">Propose a scheduled time for this swap.</p>

                    <% if (!chat.scheduled_time && !pendingScheduledTimeSafe) { %>
<form method="POST" action="/chats/<%= chat.chat_id %>/confirm/time" class="row g-2 align-items-end">
            <div class="col-md-8">
              <label class="form-label tiny">Scheduled time</label>
              <input type="datetime-local" class="form-control rounded-4" name="scheduled_time" required />
            </div>
            <div class="col-md-4 d-grid">
              <button class="btn btn-primary rounded-4" type="submit">Propose</button>
            </div>
          </form>
          <% } %>

                    <% if (pendingScheduledTimeSafe) { %>
            <% const isProposer = String(pendingScheduledTimeSafe.proposed_by_user_id) === String(user.user_id); %>
            <hr/>
            <div class="small">
              Pending: <b><span class="msg-time" data-ts="<%= pendingScheduledTimeSafe.proposed_value %>"></span></b>

              <% if (!isProposer) { %>
                <div class="mt-2 d-flex gap-2 flex-wrap">
                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/time/respond" class="d-inline">
                    <input type="hidden" name="decision" value="accept"/>
                    <button class="btn btn-success btn-sm rounded-4">Accept</button>
                  </form>

                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/time/counter" class="d-inline">
                    <div class="d-flex gap-2 align-items-end flex-wrap">
                      <div>
                        <label class="form-label tiny mb-1">Counter time</label>
                        <input type="datetime-local" class="form-control form-control-sm rounded-4" name="scheduled_time" required />
                      </div>
                      <button class="btn btn-outline-secondary btn-sm rounded-4" type="submit">Counter</button>
                    </div>
                  </form>

                  <form method="POST" action="/chats/<%= chat.chat_id %>/confirm/time/respond" class="d-inline">
                    <input type="hidden" name="decision" value="reject"/>
                    <button class="btn btn-outline-danger btn-sm rounded-4">Reject</button>
                  </form>
                </div>
                <div class="tiny mt-2">Only respond here. Accept, Counter, or Reject.</div>
              <% } else { %>
                <div class="tiny mt-2">You proposed this. Waiting for the other person to respond.</div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  

  <!-- Help modal -->
  <div class="modal fade" id="helpModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title fw-bold">Help</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="tiny mb-2">Choose an option below. This will be reviewed by admin. Payments and commands may be temporarily disabled while under review.</p>

          <form method="POST" action="/chats/<%= chat.chat_id %>/help/create" class="vstack gap-2">
            <div>
              <label class="form-label tiny">Request type</label>
              <select class="form-select rounded-4" name="case_type" required>
                <% if (Number(chat.details_locked || 0) === 0) { %>
                  <option value="cancel_request">I want to cancel match</option>
                <% } %>
                <option value="scam_report">Report scam</option>
              </select>
              <% if (Number(chat.details_locked || 0) === 1) { %>
                <div class="tiny text-muted mt-1">Cancel is disabled because details are locked.</div>
              <% } %>
            </div>

            <div>
              <label class="form-label tiny">Reason</label>
              <textarea class="form-control rounded-4" name="reason" rows="3" placeholder="Describe what happened..." required></textarea>
            </div>

            <button class="btn btn-primary rounded-4" type="submit">Submit to admin</button>
            <div class="tiny text-muted">Once submitted, it may be irreversible. Admin will respond by email.</div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script id="pageData" type="application/json"><%- JSON.stringify({
    chatId: chat.chat_id,
    openModal: openModalSafe,
    user_id: String(user.user_id),

    swap_method: chat.swap_method || null,
    payment_split: chat.payment_split || null,
    scheduled_time: chat.scheduled_time || null,
    details_locked: Number(chat.details_locked) || 0,
    meetup_location_id: chat.meetup_location_id || null,

    pendingSwapMethod: pendingSwapMethodSafe,
    pendingMeetupLocation: pendingMeetupLocationSafe,
    pendingPaymentSplit: pendingPaymentSplitSafe,
    pendingScheduledTime: pendingScheduledTimeSafe,

    myPay: myPay || null,
    paymentComplete: !!paymentComplete,

    paypalClientId: paypalClientId || "",
    paypalCurrency: paypalCurrency || "SGD",
    paypalMode: paypalMode || "sandbox"
  }) %></script>

  <script>
    let STATE = {};
    try { STATE = JSON.parse(document.getElementById('pageData').textContent); } catch {}

    // ---------------------------
    // Time formatting helpers
    // ---------------------------
    function parseTs(ts) {
      if (!ts) return null;
      if (ts instanceof Date) return ts;
      if (typeof ts === 'number') return new Date(ts);
      const s = String(ts).trim();
      if (!s) return null;
      // mysql datetime "YYYY-MM-DD HH:mm:ss"
      if (s.includes(" ") && !s.includes("T")) return new Date(s.replace(" ", "T"));
      return new Date(s);
    }

    // day+time if today, else day+date+time (your requirement)
    function formatChatTimestamp(ts) {
      const d = parseTs(ts);
      if (!d || Number.isNaN(d.getTime())) return String(ts);

      const now = new Date();
      const isToday = d.toDateString() === now.toDateString();

      const weekday = new Intl.DateTimeFormat('en-SG', { weekday: 'short' }).format(d);
      const time = new Intl.DateTimeFormat('en-SG', { hour: '2-digit', minute: '2-digit', hour12: false }).format(d);

      if (isToday) return `${weekday} ${time}`;

      const day = new Intl.DateTimeFormat('en-SG', { day: '2-digit' }).format(d);
      const month = new Intl.DateTimeFormat('en-SG', { month: 'short' }).format(d);
      return `${weekday} ${day} ${month} ${time}`;
    }

    function applyTimeFormatting(root = document) {
      root.querySelectorAll('.msg-time[data-ts]').forEach(el => {
        el.textContent = formatChatTimestamp(el.getAttribute('data-ts'));
      });
    }

    // SAHM: show reschedule hint only when within 30 mins of scheduled time AND no SAHM has accepted yet
    function applySahm30MinHint() {
      const hint = document.getElementById('sahm30MinHint');
      const banner = document.getElementById('sahmNoAvailableBanner');
      if (!hint || !banner) return;

      if (!STATE || !STATE.scheduled_time) { hint.style.display = 'none'; return; }
      const d = parseTs(STATE.scheduled_time);
      if (!d || Number.isNaN(d.getTime())) { hint.style.display = 'none'; return; }

      const diffMin = (d.getTime() - Date.now()) / 60000;
      if (diffMin <= 30 && diffMin > 0) hint.style.display = 'inline';
      else hint.style.display = 'none';
    }

    function escapeHtml(str) {
      return String(str ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ---------------------------
    // Commands (Tinder-like drawer)
    // ---------------------------
    function getCommands() {
      const list = [
        { name: '/confirmSwapMethod',   desc: 'Propose / accept / counter swap method', open: 'swapMethod' },
        { name: '/confirmLocation',     desc: 'Meetup: propose location • SAHM: set your address', open: 'location' }
      ];

      // Payment split only applies to SAHM swaps
      if (String(STATE.swap_method || '') === 'sahm') {
        list.push({ name: '/confirmPaymentSplit', desc: 'Propose / accept / counter payment split (SAHM)', open: 'paymentSplit' });
      }

      list.push({ name: '/confirmTime', desc: 'Propose / accept / counter scheduled time', open: 'time' });
      list.push({ name: '/help',        desc: 'Report scam or request cancel (admin review)', open: 'help' });

      return list;
    }

    function openDrawer() {
      const drawer = document.getElementById('cmdDrawer');
      drawer.style.display = 'block';
    }
    function closeDrawer() {
      const drawer = document.getElementById('cmdDrawer');
      drawer.style.display = 'none';
      drawer.innerHTML = '';
    }
    
    function setActiveItem(idx) {
  activeIndex = idx;
  const drawer = document.getElementById('cmdDrawer');
  [...drawer.querySelectorAll('.cmd-item')].forEach((el, i) => {
    el.classList.toggle('active', i === activeIndex);
  });
}



    let activeIndex = 0;
    function renderCommands(list) {
  const drawer = document.getElementById('cmdDrawer');
  drawer.innerHTML = '';

  list.forEach((c, idx) => {
    const item = document.createElement('div');
    item.className = 'cmd-item' + (idx === activeIndex ? ' active' : '');
    item.dataset.idx = String(idx);

    item.innerHTML = `
      <div class="cmd-left">
        <p class="cmd-name mb-0">${escapeHtml(c.name)}</p>
        <p class="cmd-desc mb-0">${escapeHtml(c.desc)}</p>
      </div>
      <span class="cmd-pill">open</span>
    `;

    // ✅ DO NOT re-render on hover. Just update active highlight.
    item.addEventListener('mouseenter', () => setActiveItem(idx));

    item.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();

      const input = document.getElementById('msgInput');
      input.value = '';
      closeDrawer();

      if (c.open === 'swapMethod') openModalById('swapMethodModal', false);
      if (c.open === 'location') openModalById('locationModal', false);
      if (c.open === 'paymentSplit') openModalById('paymentSplitModal', false);
      if (c.open === 'time') openModalById('timeModal', false);
      if (c.open === 'help') openModalById('helpModal', false);
    });

    drawer.appendChild(item);
  });
}


    function filterCommands(query) {
      const q = (query || '').toLowerCase();
      const filtered = getCommands().filter(c => c.name.toLowerCase().includes(q));
      activeIndex = 0;
      renderCommands(filtered.length ? filtered : getCommands());
    }

    // ---------------------------
    // Auto refresh (AJAX)
    // ---------------------------
    let pollTimer = null;
    let lastRefreshAt = Date.now();

    function setUpdatedLabel(msAgo) {
      const el = document.getElementById('updatedLabel');
      if (!el) return;

      const s = Math.floor(msAgo / 1000);
      if (s <= 1) el.textContent = 'Updated just now';
      else el.textContent = `Updated ${s}s ago`;
    }

    async function refreshWholeView() {
      // Pause refresh if any modal is open (so your command picking won't get interrupted)
      const anyModalOpen = document.querySelector('.modal.show');
      if (anyModalOpen) return;

      const chatId = Number(STATE.chatId);
      if (!chatId) return;

      try {
        const res = await fetch(`/chats/${chatId}?partial=1`, { headers: { 'X-Requested-With': 'fetch' } });
        if (!res.ok) return;

        const html = await res.text();
        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        const newMessages = tmp.querySelector('#messagesBox');
        const newStatus = tmp.querySelector('#statusArea');
        const newPageData = tmp.querySelector('#pageData');

        const curMessages = document.querySelector('#messagesBox');
        const curStatus = document.querySelector('#statusArea');

        if (newMessages && curMessages) curMessages.innerHTML = newMessages.innerHTML;
        if (newStatus && curStatus) curStatus.innerHTML = newStatus.innerHTML;

        if (newPageData) {
          try { STATE = JSON.parse(newPageData.textContent); }
          catch { /* ignore */ }
        }

        applyTimeFormatting(document);
        applySahm30MinHint();

        lastRefreshAt = Date.now();
        setUpdatedLabel(0);
      } catch (e) {
        // silent
      }
    }

    function startPolling() {
      if (pollTimer) return;
      pollTimer = setInterval(() => {
        const msAgo = Date.now() - lastRefreshAt;
        setUpdatedLabel(msAgo);
        refreshWholeView();
      }, 2500);
    }

    // ---------------------------
    // Modals
    // ---------------------------
    function openModalById(id, forceStatic) {
      const el = document.getElementById(id);
      if (!el) return;
      if (forceStatic) el.classList.add('force-locked');
      else el.classList.remove('force-locked');
      const opts = forceStatic ? { backdrop:'static', keyboard:false } : {};
      const modal = new bootstrap.Modal(el, opts);
      modal.show();
    }

    // ---------------------------
    // Init
    // ---------------------------
    (function init() {
      applyTimeFormatting(document);
      applySahm30MinHint();

      const input = document.getElementById('msgInput');
      const drawer = document.getElementById('cmdDrawer');

      // auto-resize textarea
      input.addEventListener('input', () => {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
      });

      // open drawer on "/"
      input.addEventListener('input', () => {
        const v = (input.value || "");
        if (v.startsWith("/")) { openDrawer(); filterCommands(v); }
        else closeDrawer();
      });

      input.addEventListener('keydown', (e) => {
        if (drawer.style.display !== 'block') return;

        const q = (input.value || '').toLowerCase();
        const filtered = getCommands().filter(c => c.name.toLowerCase().includes(q));
        const list = filtered.length ? filtered : getCommands();

        if (e.key === 'Escape') {
          e.preventDefault();
          closeDrawer();
          input.value = '';
          return;
        }
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          activeIndex = (activeIndex + 1) % list.length;
          renderCommands(list);
        }
        if (e.key === 'ArrowUp') {
          e.preventDefault();
          activeIndex = (activeIndex - 1 + list.length) % list.length;
          renderCommands(list);
        }
        if (e.key === 'Enter' && !e.shiftKey) {
          // select command
          if (drawer.style.display !== 'block') return;
          e.preventDefault();
          const c = list[activeIndex];
          closeDrawer();
          if (c.open === 'swapMethod') openModalById('swapMethodModal', false);
          if (c.open === 'location') openModalById('locationModal', false);
          if (c.open === 'paymentSplit') openModalById('paymentSplitModal', false);
          if (c.open === 'time') openModalById('timeModal', false);
          if (c.open === 'help') openModalById('helpModal', false);
          input.value = '';

        }
      });

      // If drawer is closed: typing an exact command + Enter opens modal immediately
      function matchExactCommand(val) {
        const v = String(val || '').trim();
        return getCommands().find(c => c.name.toLowerCase() == v.toLowerCase()) || null;
      }

      input.addEventListener('keydown', (e) => {
        // Allow Enter to trigger commands even if the command drawer is currently open
        if (e.key === 'Enter' && !e.shiftKey) {
          const raw = String(input.value || '').trim();
          if (raw.toLowerCase() === '/confirmpaymentsplit' && String(STATE.swap_method || '') !== 'sahm') {
            e.preventDefault();
            alert('Payment split is only for SwapMates Delivery (SAHM). Choose SwapMates as your swap method first.');
            input.value = '';
            closeDrawer();
            return;
          }

          const cmd = matchExactCommand(input.value);
          if (cmd) {
            e.preventDefault();
            if (cmd.open === 'swapMethod') openModalById('swapMethodModal', false);
            if (cmd.open === 'location') openModalById('locationModal', false);
            if (cmd.open === 'paymentSplit') openModalById('paymentSplitModal', false);
            if (cmd.open === 'time') openModalById('timeModal', false);
            if (cmd.open === 'help') openModalById('helpModal', false);
            input.value = '';
            closeDrawer();
            return;
          }
        }
      });



      // Force non-dismissible modals for the user who must respond (no typing needed)
      function forcePendingOffers() {
        const uid = String(STATE.user_id || '');
        const pm = STATE.pendingSwapMethod;
        const pl = STATE.pendingMeetupLocation;
        const pp = STATE.pendingPaymentSplit;
        const pt = STATE.pendingScheduledTime;

        // If proposed_to_user_id is missing (older rows), fall back to "the other user".
        const shouldForce = (p, isAlreadySet) => {
          if (!p || p.status !== 'pending') return false;
          if (isAlreadySet) return false;
          const toId = String(p.proposed_to_user_id || '');
          if (toId && toId === uid) return true;
          if (!toId && String(p.proposed_by_user_id || '') !== uid) return true;
          return false;
        };

        if (shouldForce(pm, !!STATE.swap_method)) {
          openModalById('swapMethodModal', true);
          return true;
        }

        if (shouldForce(pl, !!STATE.meetup_location_id) && STATE.swap_method === 'meetup') {
          openModalById('locationModal', true);
          return true;
        }

        if (shouldForce(pp, !!STATE.payment_split) && String(STATE.swap_method || '') === 'sahm') {
          openModalById('paymentSplitModal', true);
          return true;
        }

        if (shouldForce(pt, !!STATE.scheduled_time)) {
          openModalById('timeModal', true);
          return true;
        }

        return false;
      }

      // open requested modal (server signals)
      const forced = forcePendingOffers();
      const open = forced ? '' : (STATE.openModal || '');
      if (open === 'swapMethod') openModalById('swapMethodModal', false);
      if (open === 'location') openModalById('locationModal', false);
      if (open === 'paymentSplit') openModalById('paymentSplitModal', false);
      if (open === 'time') openModalById('timeModal', false);
      // PayPal buttons only when needed, but gated by Email OTP (payment security)
      const needPay = STATE.myPay && STATE.myPay.required && STATE.myPay.status !== 'captured';
      // If payment is required (e.g., user chose "I pay all" and it got accepted), force-open payment modal
      // so the payer doesn't have to type /confirmPaymentSplit again.
      if (!forced && String(STATE.swap_method || '') === 'sahm' && needPay) {
        openModalById('paymentSplitModal', true);
      }

      const chatId = Number(STATE.chatId);
      const otpBlock = document.getElementById('paymentOtpBlock');
      const otpStatus = document.getElementById('otpStatus');
      const btnSendOtp = document.getElementById('btnSendOtp');
      const btnVerifyOtp = document.getElementById('btnVerifyOtp');
      const otpCodeInput = document.getElementById('otpCodeInput');
      const paypalBlock = document.getElementById('paypalBlock');
      let paypalMounted = false;

      async function fetchJson(url, opts) {
        try {
          const res = await fetch(url, opts);
          const txt = await res.text();
          let json = null;
          try { json = txt ? JSON.parse(txt) : null; } catch {}
          if (!res.ok) return json || { ok:false, error:`HTTP ${res.status}` };
          return json;
        } catch (e) {
          return { ok:false, error:'Network error' };
        }
      }


      async function checkOtpStatus() {
        if (!needPay || !otpStatus) return { ok:false };
        const data = await fetchJson(`/chats/${chatId}/payment-otp/status`, { method:'GET' });
        return data || { ok:false };
      }

      async function sendOtp() {
        if (!btnSendOtp) return;
        btnSendOtp.disabled = true;
        const data = await fetchJson(`/chats/${chatId}/payment-otp/send`, { method:'POST' });
        if (otpStatus) otpStatus.textContent = (data && data.ok) ? 'OTP sent. Check your email.' : (data?.error || 'Failed to send OTP.');
        setTimeout(() => { btnSendOtp.disabled = false; }, 2500);
      }

      async function verifyOtp() {
        if (!btnVerifyOtp) return;
        const code = String(otpCodeInput?.value || '').trim();
        if (!code) {
          if (otpStatus) otpStatus.textContent = 'Please enter the OTP.';
          return;
        }
        btnVerifyOtp.disabled = true;
        const data = await fetchJson(`/chats/${chatId}/payment-otp/verify`, {
          method:'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ otp: code })
        });
        if (data && data.ok) {
          if (otpStatus) otpStatus.textContent = 'OTP verified. You may proceed to PayPal.';
          if (otpBlock) otpBlock.style.display = 'none';
          if (paypalBlock) paypalBlock.style.display = 'block';
          mountPayPal();
        } else {
          if (otpStatus) otpStatus.textContent = (data?.error || 'Invalid OTP. Try again.');
        }
        btnVerifyOtp.disabled = false;
      }
function mountPayPal() {
  const mount = document.getElementById('paypalButtons');
  if (!needPay || paypalMounted || !mount || !window.paypal) return;

  paypalMounted = true;
  mount.innerHTML = ''; // ensure clean mount

  paypal.Buttons({
    createOrder: async () => {
      const data = await fetchJson(`/chats/${chatId}/paypal/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({})
      });
      if (!data || !data.ok) throw new Error(data?.error || 'Create order failed');
      return data.orderID;
    },

    onApprove: (data) => {
      return (async () => {
        const out = await fetchJson(`/chats/${chatId}/paypal/capture-order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID })
        });

        if (!out || !out.ok) {
          alert(out?.error || 'Capture failed');

          // reset so you can try again
          paypalMounted = false;
          const m = document.getElementById('paypalButtons');
          if (m) m.innerHTML = '';

          // show otp again only if backend says verification needed
          if ((out?.error || '').toLowerCase().includes('verification')) {
            if (paypalBlock) paypalBlock.style.display = 'none';
            if (otpBlock) otpBlock.style.display = 'block';
            if (otpStatus) otpStatus.textContent = out?.error || 'Secure verification required.';
          }

          throw new Error(out?.error || 'Capture failed');
        }

        window.location.href = `/chats/${chatId}`;
        return out;
      })();
    },

    onError: (err) => {
      console.error('[PayPal] error:', err);
      alert('PayPal error. Please try again.');
      paypalMounted = false;
      const m = document.getElementById('paypalButtons');
      if (m) m.innerHTML = '';
    }
  }).render('#paypalButtons');
}


      async function initOtpGate() {
        if (!needPay) return;
        if (paypalBlock) paypalBlock.style.display = 'none';
        if (otpBlock) otpBlock.style.display = 'block';

        const st = await checkOtpStatus();
        if (st && st.ok && st.verified) {
          if (otpStatus) otpStatus.textContent = 'OTP verified. You may proceed to PayPal.';
          if (otpBlock) otpBlock.style.display = 'none';
          if (paypalBlock) paypalBlock.style.display = 'block';
          mountPayPal();
        } else {
          if (otpStatus) otpStatus.textContent = 'OTP not verified yet.';
        }
      }

      if (btnSendOtp) btnSendOtp.addEventListener('click', sendOtp);
      if (btnVerifyOtp) btnVerifyOtp.addEventListener('click', verifyOtp);

      // Run OTP gate on load; also re-run whenever the payment split modal is opened
      initOtpGate();
      const payModalEl = document.getElementById('paymentSplitModal');
      if (payModalEl) {
        payModalEl.addEventListener('shown.bs.modal', () => {
          paypalMounted = false; // re-mount if needed
          initOtpGate();
        });
      }

      startPolling();
    })();
  </script>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Leave a Review</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="reviewForm" action="/reviews/submit" method="POST">
        <div class="modal-body">
          <input type="hidden" name="match_id" value="<%= chat.match_id %>">
          
          <div class="mb-3">
            <label for="reviewRating" class="form-label">Rating (1-5 stars)</label>
            <div class="d-flex gap-2">
              <% for (let i = 1; i <= 5; i++) { %>
                <label class="form-check" style="cursor: pointer; font-size: 1.5rem;">
                  <input class="form-check-input" type="radio" name="rating" value="<%= i %>" required>
                  <span id="star<%= i %>" style="color: #ddd;">⭐</span>
                </label>
              <% } %>
            </div>
          </div>

          <div class="mb-3">
            <label for="reviewComment" class="form-label">Comment (optional)</label>
            <textarea class="form-control" id="reviewComment" name="comment" rows="3" maxlength="500" placeholder="Share your experience..."></textarea>
            <small class="text-muted">Max 500 characters</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700;">
            Submit Review
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Star rating interaction
  document.querySelectorAll('input[name="rating"]').forEach(radio => {
    radio.addEventListener('change', function() {
      const selectedRating = this.value;
      for (let i = 1; i <= 5; i++) {
        const star = document.getElementById('star' + i);
        if (i <= selectedRating) {
          star.style.color = '#ffc107';
        } else {
          star.style.color = '#ddd';
        }
      }
    });

    radio.addEventListener('mouseenter', function() {
      const hoverRating = this.value;
      for (let i = 1; i <= 5; i++) {
        const star = document.getElementById('star' + i);
        if (i <= hoverRating) {
          star.style.color = '#ffb300';
        } else {
          star.style.color = '#ddd';
        }
      }
    });
  });

  document.getElementById('reviewForm').addEventListener('mouseout', function() {
    document.querySelectorAll('input[name="rating"]').forEach(radio => {
      const star = document.getElementById('star' + radio.value);
      if (radio.checked) {
        star.style.color = '#ffc107';
      } else {
        star.style.color = '#ddd';
      }
    });
  });

  // Submit review form
  document.getElementById('reviewForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const rating = formData.get('rating');
    
    if (!rating) {
      alert('Please select a rating');
      return;
    }

    const reviewData = {
      match_id: formData.get('match_id'),
      rating: formData.get('rating'),
      comment: formData.get('comment')
    };

    fetch('/reviews/submit', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(reviewData)
    })
    .then(response => response.text())
    .then(data => {
      const modal = bootstrap.Modal.getInstance(document.getElementById('reviewModal'));
      modal.hide();
      alert('Review submitted successfully!');
      location.reload();
    })
    .catch(error => {
      console.error('Error:', error);
      alert('Failed to submit review');
    });
  });
</script>

<!-- AI Chatbot Widget -->
<%- include('ai-chatbot-widget') %>

</body>
</html>
