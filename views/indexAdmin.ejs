<!DOCTYPE html>
<html lang="en" >
<head>
    <meta charset="UTF-8">
    <title>Clothes Swap | Home</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Global Design System -->
    <link href="/css/global-design.css" rel="stylesheet">

    <style>

        @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;800;900&family=Archivo+Black&display=swap');

        .feed-container {
            padding-top: 1rem;
            padding-bottom: 5rem; /* space for floating button */
        }

        .ootd-card {
            border-radius: 16px;
            border: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05);
            overflow: hidden;
            background-color: #fff;
        }

        .ootd-header {
            padding: 0.75rem 1rem;
        }

        .profile-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary);
        }

        .username-text {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .ootd-caption {
            font-size: 0.9rem;
        }

        .ootd-image {
            width: 100%;
            height: 320px;
            object-fit: cover;
        }

        .pill-tag {
            font-size: 0.7rem;
            border-radius: 999px;
            padding: 0.15rem 0.55rem;
            background-color: #f1f1f1;
            color: #555;
        }

        .alert-message {
            border-radius: 10px;
        }

        .hint-text {
            font-size: 0.8rem;
            color: #6c757d;
        }

        /* Floating create OOTD button (like TikTok center +) */
        .floating-create-btn {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: #fff;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            text-decoration: none;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
        }

        .floating-create-btn:hover {
            background: #cc0000;
            color: #fff;
            text-decoration: none;
        }

        .nav-link-active {
            color: var(--primary) !important;
            font-weight: 600;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 1rem;
            color: #777;
        }

        .empty-state h5 {
            font-weight: 600;
        }

        .empty-state p {
            font-size: 0.9rem;
        }

        .link-accent {
            color: var(--primary);
            font-weight: 600;
            text-decoration: none;
        }

        .link-accent:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* search results styling */
        .user-result-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-result-initial {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 0.8rem;
            color: #999;
        }

    /* Frutiger Metro Dynamic Background */
    body {
        background: linear-gradient(45deg, #E8F4F8, #F0E8F8, #F8F0E8, #E8F8F0, #F8F0F0, #E8F4F8);
        background-size: 400% 400%;
        animation: metro-flow 30s ease infinite;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, rgba(0, 120, 215, 0.12) 0%, transparent 30%, transparent 70%, rgba(0, 120, 215, 0.12) 100%),
            linear-gradient(180deg, rgba(255, 140, 0, 0.08) 0%, transparent 40%, transparent 60%, rgba(255, 140, 0, 0.08) 100%),
            linear-gradient(45deg, rgba(107, 142, 35, 0.1) 0%, transparent 50%, transparent 50%, rgba(107, 142, 35, 0.1) 100%);
        animation: metro-grid 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 0%, rgba(0, 120, 215, 0.05) 25%, rgba(0, 120, 215, 0.05) 75%, transparent 100%),
            linear-gradient(0deg, transparent 0%, rgba(255, 140, 0, 0.04) 50%, transparent 100%);
        background-size: 200% 100%, 100% 200%;
        animation: metro-slide 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes metro-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes metro-grid {
        0%, 100% { transform: scale(1) translateY(0); filter: brightness(1); }
        25% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
        50% { transform: scale(1.01) translateY(-10px); filter: brightness(1.05); }
        75% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
    }

    @keyframes metro-slide {
        0%, 100% { background-position: 0% 0%, 0% 0%; }
        50% { background-position: 100% 0%, 0% 100%; }
    }

    body > * {
        position: relative;
        z-index: 1;
    }
    </style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid px-4">
        <a class="navbar-brand" href="/">Clothes <span class="brand-red">Swap</span></a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="mainNavbar">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0" style="display: flex; align-items: center; gap: 0.8rem;">
                <li class="nav-item">
                    <a class="nav-link" href="/adminpage">Home</a>
                </li>

                <% if (user) { %>
                    <% if (user.role === 'admin') { %>
                        <li class="nav-item">
                            <a class="nav-link active" href="/admin">Admin</a>
                        </li>
                    <% } %>
                    <li class="nav-item ms-lg-2"><a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.7rem 1.6rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2); font-size: 0.95rem; font-family: 'Cinzel', serif; letter-spacing: 0.08em; text-transform: uppercase; display: flex; align-items: center;" href="/logout" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Logout</a></li>
                <% } else { %>
                    <li class="nav-item ms-lg-2"><a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.7rem 1.6rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2); font-size: 0.95rem; font-family: 'Cinzel', serif; letter-spacing: 0.08em; text-transform: uppercase; display: flex; align-items: center;" href="/login" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Sign In</a></li>
                <% } %>
            </ul>
        </div>
    </div>
</nav>

<!-- Guest banner -->
<% if (!user) { %>
    <div class="alert alert-light text-center mt-3 mx-3 shadow-sm" style="border-radius: 12px;">
        <strong>Welcome, guest!</strong> You can browse OOTD posts, but to swap items or create posts, please
        <a href="/login" class="link-accent">sign in</a>.
    </div>
<% } %>

<!-- MAIN FEED -->
<div class="container feed-container" >

    <!-- Flash / local messages -->
    <div class="mt-3">
        <% if (typeof success_msg !== 'undefined' && success_msg && success_msg.length > 0) { %>
            <div class="alert alert-success alert-message"><%= success_msg %></div>
        <% } %>

        <% if (typeof error_msg !== 'undefined' && error_msg && error_msg.length > 0) { %>
            <div class="alert alert-success alert-message"><%= error_msg %></div>
        <% } %>

        <% if (message) { %>
            <div class="alert alert-info alert-message"><%= message %></div>
        <% } %>
    </div>

    <!-- USER SEARCH BAR -->
    <div class="mt-3">
        <form action="/search-users" method="GET" class="d-flex">
            <input 
                type="text" 
                name="q"
                value="<%= typeof query !== 'undefined' ? query : '' %>" 
                class="form-control me-2" 
                placeholder="Search users by username or email..."
            >
            <button class="btn btn-success">Search</button>
        </form>
    </div>

    <!-- SEARCH RESULTS -->
    <% if (searchResults && searchResults.length > 0) { %>
        <div class="mt-4">
            <h5 class="mb-3">Users</h5>
            <div class="list-group">
                <% searchResults.forEach(u => { %>
                    <a href="/users/<%= u.user_id %>" class="list-group-item list-group-item-action d-flex align-items-center">
                        <% if (u.profile_image_url) { %>
                            <img 
                                src="<%= u.profile_image_url %>" 
                                alt="Profile" 
                                class="user-result-avatar me-3"
                            >
                        <% } else { %>
                            <div 
                                class="user-result-initial me-3 d-flex align-items-center justify-content-center bg-light"
                            >
                                <%= u.username ? u.username.charAt(0).toUpperCase() : '?' %>
                            </div>
                        <% } %>

                        <div>
                            <strong><%= u.username || 'Unknown User' %></strong><br>
                            <small class="text-muted"><%= u.email %></small>
                        </div>
                    </a>
                <% }) %>
            </div>
        </div>
    <% } else if (typeof query !== 'undefined' && query && (!searchResults || searchResults.length === 0)) { %>
        <div class="mt-4">
            <div class="alert alert-light border-0 shadow-sm">
                No users found for "<strong><%= query %></strong>".
            </div>
        </div>
    <% } %>

<!-- OOTD Feed -->
<% if (ootdPosts && ootdPosts.length > 0) { %>
    <div class="row g-4 mt-3">
        <% ootdPosts.forEach(post => { %>
            <div class="col-12 col-md-6 col-lg-4">
                <div class="ootd-card">

                    <!-- Card header -->
                    <div class="ootd-header d-flex align-items-center">
                        <a 
                            href="/users/<%= post.user_id %>"
                            class="d-flex align-items-center text-decoration-none text-dark"
                        >
                            <% if (post.profile_image_url) { %>
                                <img 
                                    src="<%= post.profile_image_url %>"
                                    class="profile-circle me-2"
                                >
                            <% } else { %>
                                <div class="profile-circle me-2 d-flex align-items-center justify-content-center bg-light text-muted">
                                    <%= post.username.charAt(0).toUpperCase() %>
                                </div>
                            <% } %>

                            <div>
                                <div class="username-text"><%= post.username %></div>
                                <div class="text-muted" style="font-size: 0.75rem;">OOTD</div>
                            </div>
                        </a>
                    </div>

                    <!-- OOTD IMAGES with carousel -->
                    <div class="ootd-image-wrapper" style="
                        background: radial-gradient(circle at top, #f3f4ff 0%, #eef1f6 45%, #e5e7eb 100%);
                        padding: 0.5rem;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    ">
                        <%
                            const imgList = [];
                            if (post.image_url_1) imgList.push(post.image_url_1);
                            if (post.image_url_2) imgList.push(post.image_url_2);
                            if (post.image_url_3) imgList.push(post.image_url_3);
                        %>

                        <% if (imgList.length === 0) { %>
                            <div class="ootd-image d-flex align-items-center justify-content-center bg-light text-muted">
                                No image
                            </div>

                        <% } else if (imgList.length === 1) { %>
                            <img src="<%= imgList[0] %>" class="ootd-image" style="
                                width: 100%;
                                max-height: 320px;
                                object-fit: contain;
                            ">

                        <% } else { %>
                            <div id="feedCarousel-<%= post.post_id %>" class="carousel slide w-100" data-bs-ride="carousel">
                                <div class="carousel-inner">
                                    <% imgList.forEach((src, idx) => { %>
                                        <div class="carousel-item <%= idx === 0 ? 'active' : '' %>">
                                            <img 
                                                src="<%= src %>"
                                                class="ootd-image d-block mx-auto"
                                                style="width:100%; max-height:320px; object-fit:contain;"
                                            >
                                        </div>
                                    <% }) %>
                                </div>

                                <button class="carousel-control-prev" type="button" data-bs-target="#feedCarousel-<%= post.post_id %>" data-bs-slide="prev">
                                    <span class="carousel-control-prev-icon"></span>
                                </button>

                                <button class="carousel-control-next" type="button" data-bs-target="#feedCarousel-<%= post.post_id %>" data-bs-slide="next">
                                    <span class="carousel-control-next-icon"></span>
                                </button>
                            </div>
                        <% } %>

                    </div>

                    <!-- Caption + Visibility -->
                    <div class="p-3">
                        <p class="ootd-caption mb-2">
                            <%= post.caption || '<span class="text-muted">No caption provided.</span>' %>
                        </p>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="pill-tag">
                                <%= post.visibility === 'private' ? 'Private' : 'Public' %>
                            </span>
                           
                        </div>
                    </div>

                </div>
            </div>
        <% }) %>
    </div>
<% } else { %>
    <div class="empty-state">
        <h5>No OOTD posts yet</h5>
        <p>Be the first to share your outfit of the day.</p>
    </div>
<% } %>

</div>

<!-- Floating + button to create OOTD -->
<% if (user) { %>
    <a href="/create-ootd" class="floating-create-btn" title="Create OOTD">
        +
    </a>
<% } else { %>
    <a href="/login" class="floating-create-btn" title="Log in to post OOTD">
        +
    </a>
<% } %>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<!-- AI Chatbot Widget -->
<%- include('ai-chatbot-widget') %>

</body>
</html>
