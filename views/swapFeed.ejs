<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Swap Feed</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Global Design System -->
  <link href="/css/global-design.css" rel="stylesheet">

  <style>
    :root{
      --danger: var(--primary);
      --shadow: 0 12px 48px rgba(45, 90, 79, 0.15);
    }

    .brand-red { color: var(--primary); font-weight: 800; letter-spacing: .4px; }
    .nav-link-active { font-weight: 700; color: var(--primary) !important; }

    .feed-wrap { max-width: 520px; margin: 0 auto; padding: 18px 12px 40px; }
    .hint { color: #6B7280; font-size: .92rem; }

    .deck {
      position: relative;
      width: 100%;
      height: 640px;
      margin-top: 14px;
    }

    .card-swipe {
      position: absolute;
      inset: 0;
      border-radius: 22px;
      overflow: hidden;
      background: #fff;
      box-shadow: var(--shadow);
      user-select: none;
      touch-action: none;
      transform: translate(0,0) rotate(0deg);
      transition: transform 220ms ease;
    }

    .card-swipe.is-top { cursor: grab; }
    .card-swipe.is-top:active { cursor: grabbing; }

    .card-img {
      width: 100%;
      height: 72%;
      object-fit: cover;
      background: #e9ecef;
      display: block;
    }

    .card-body { padding: 16px 16px 14px; }

    .title {
      font-size: 1.2rem;
      font-weight: 800;
      line-height: 1.1;
      margin-bottom: 4px;
    }
    .meta { color: rgba(0,0,0,.6); font-size: .92rem; }

    .pills { margin-top: 10px; display:flex; flex-wrap:wrap; gap:8px; }
    .pill {
      font-size: .82rem;
      border: 1px solid rgba(0,0,0,.12);
      padding: .22rem .58rem;
      border-radius: 999px;
      background: #fff;
      color: rgba(0,0,0,.75);
    }

    .badge-like, .badge-nope {
      position: absolute;
      top: 18px;
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 900;
      letter-spacing: 1px;
      font-size: 1.25rem;
      border: 4px solid;
      text-transform: uppercase;
      opacity: 0;
      transform: rotate(-12deg);
      transition: opacity 80ms linear;
      background: rgba(255,255,255,.85);
      backdrop-filter: blur(4px);
    }
    .badge-like {
      left: 18px;
      color: #198754;
      border-color: #198754;
    }
    .badge-nope {
      right: 18px;
      color: var(--danger);
      border-color: var(--danger);
      transform: rotate(12deg);
    }

    .actions {
      display:flex;
      justify-content:center;
      gap: 14px;
      margin-top: 16px;
    }
    .action-btn{
      width: 62px;
      height: 62px;
      border-radius: 999px;
      border: none;
      background: #fff;
      box-shadow: 0 10px 22px rgba(0,0,0,.10);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 20px;
      transition: transform 120ms ease;
    }
    .action-btn:active { transform: scale(.96); }
    .btn-pass { border: 2px solid rgba(220,53,69,.25); color: var(--danger); }
    .btn-like { border: 2px solid rgba(25,135,84,.25); color: #198754; }

    .empty {
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(0,0,0,.08);
      padding: 18px;
      box-shadow: 0 10px 24px rgba(0,0,0,.06);
      text-align:center;
      margin-top: 18px;
    }

    .tiny { font-size: .85rem; color: rgba(0,0,0,.6); }

    /* Frutiger Metro Dynamic Background */
    body {
        background: linear-gradient(45deg, #E8F4F8, #F0E8F8, #F8F0E8, #E8F8F0, #F8F0F0, #E8F4F8);
        background-size: 400% 400%;
        animation: metro-flow 30s ease infinite;
        position: relative;
        min-height: 100vh;
        overflow-x: hidden;
        color: #333;
    }
    
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, rgba(0, 120, 215, 0.12) 0%, transparent 30%, transparent 70%, rgba(0, 120, 215, 0.12) 100%),
            linear-gradient(180deg, rgba(255, 140, 0, 0.08) 0%, transparent 40%, transparent 60%, rgba(255, 140, 0, 0.08) 100%),
            linear-gradient(45deg, rgba(107, 142, 35, 0.1) 0%, transparent 50%, transparent 50%, rgba(107, 142, 35, 0.1) 100%);
        animation: metro-grid 20s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    body::after {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: 
            linear-gradient(90deg, transparent 0%, rgba(0, 120, 215, 0.05) 25%, rgba(0, 120, 215, 0.05) 75%, transparent 100%),
            linear-gradient(0deg, transparent 0%, rgba(255, 140, 0, 0.04) 50%, transparent 100%);
        background-size: 200% 100%, 100% 200%;
        animation: metro-slide 25s ease-in-out infinite;
        pointer-events: none;
        z-index: 0;
    }

    @keyframes metro-flow {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
    }

    @keyframes metro-grid {
        0%, 100% { transform: scale(1) translateY(0); filter: brightness(1); }
        25% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
        50% { transform: scale(1.01) translateY(-10px); filter: brightness(1.05); }
        75% { transform: scale(1.02) translateY(-5px); filter: brightness(1.03); }
    }

    @keyframes metro-slide {
        0%, 100% { background-position: 0% 0%, 0% 0%; }
        50% { background-position: 100% 0%, 0% 100%; }
    }

    body > * {
        position: relative;
        z-index: 1;
    }
  </style>
</head>

<body>

  <!-- YOUR NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid px-4">
      <a class="navbar-brand" href="/">Clothes <span class="brand-red">Swap</span></a>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="mainNavbar">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0" style="display: flex; align-items: center; gap: 0.8rem;">

          <li class="nav-item">
            <a class="nav-link" aria-current="page" href="/">Home</a>
          </li>

          <!-- Inbox / Wardrobe / Swap / SwapMates only for logged in users -->
          <% if (user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/inbox">Inbox</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/wardrobe">Wardrobe</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/swap">Swap</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sahm">SwapMates</a>
            </li>
          <% } %>

          <% if (user) { %>
            <li class="nav-item">
              <a class="nav-link" href="/profile">Profile</a>
            </li>
            <li class="nav-item ms-lg-2">
              <a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.7rem 1.6rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2); font-size: 0.95rem; font-family: 'Cinzel', serif; letter-spacing: 0.08em; text-transform: uppercase; display: flex; align-items: center;" href="/logout" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Logout</a>
            </li>
          <% } else { %>
            <!-- Guest users: show Sign In -->
            <li class="nav-item ms-lg-2">
              <a class="btn btn-sm" style="background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%); color: white; border: none; border-radius: 10px; font-weight: 700; padding: 0.7rem 1.6rem; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(45, 90, 79, 0.2); font-size: 0.95rem; font-family: 'Cinzel', serif; letter-spacing: 0.08em; text-transform: uppercase; display: flex; align-items: center;" href="/login" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(45, 90, 79, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(45, 90, 79, 0.2)';">Sign In</a>
            </li>
          <% } %>
        </ul>
      </div>
    </div>
  </nav>

  <div class="feed-wrap">

    <div class="d-flex align-items-start justify-content-between gap-3 mt-3">
      <div>
        <h3 class="fw-bold mb-1">Swap Feed</h3>
        <div class="hint">Drag right to <b>Like</b>, left to <b>Pass</b>. Buttons work too.</div>
      </div>
      <div class="text-end">
        <a href="/swap/incoming" class="btn btn-sm btn-success rounded-pill">Incoming</a>
        <a href="/swap/matches" class="btn btn-sm btn-success rounded-pill ms-1">Matches</a>
      </div>
    </div>

    <!-- Flash messages (safe for req.flash arrays) -->
    <%
      const hasMsgs = (v) => Array.isArray(v) ? v.length > 0 : (v && String(v).trim().length > 0);
    %>
    <% if (typeof success_msg !== 'undefined' && hasMsgs(success_msg)) { %>
      <div class="alert alert-success mt-3">
        <% if (Array.isArray(success_msg)) { success_msg.forEach(m => { %><div><%= m %></div><% }) } else { %>
          <%= success_msg %>
        <% } %>
      </div>
    <% } %>
    <% if (typeof error_msg !== 'undefined' && hasMsgs(error_msg)) { %>
      <div class="alert alert-success mt-3">
        <% if (Array.isArray(error_msg)) { error_msg.forEach(m => { %><div><%= m %></div><% }) } else { %>
          <%= error_msg %>
        <% } %>
      </div>
    <% } %>

    <!-- ✅ NEW: Gate the swapfeed if user has no swap items -->
    <% if (mustAddSwapItem) { %>

      <div class="empty">
        <h5 class="fw-bold mb-2">Add an item to swap first</h5>
        <div class="tiny mb-3">
          You need at least <b>1 available item</b> in your wardrobe marked as <b>For Swap</b> before you can swipe.
        </div>
        <div class="d-flex justify-content-center gap-2 flex-wrap">
          <a href="/wardrobe" class="btn btn-success rounded-pill">Go to Wardrobe</a>
          <a href="/wardrobe/upload" class="btn btn-outline-success rounded-pill">Add Item</a>
        </div>
      </div>

    <% } else { %>

      <% if (!items || items.length === 0) { %>
        <div class="empty">
          <h5 class="fw-bold mb-2">No more items right now</h5>
          <div class="tiny mb-3">You’ve swiped through everything available. Check back later.</div>
          <a href="/swap" class="btn btn-success rounded-pill">Refresh</a>
        </div>
      <% } else { %>

        <div class="deck" id="deck">
          <%
            // Render reversed so the last one is on top after zIndex assignment
            const reversed = items.slice().reverse();
            reversed.forEach((item) => {
          %>
            <div class="card-swipe" data-item-id="<%= item.item_id %>">
              <div class="badge-like">LIKE</div>
              <div class="badge-nope">NOPE</div>

              <img
                class="card-img"
                src="<%= item.image_url_1 || '/images/placeholder.png' %>"
                alt="<%= item.title %>"
                onerror="this.src='/images/placeholder.png';"
              />

              <div class="card-body">
                <div class="title"><%= item.title %></div>
                <div class="meta">
                  <% if (item.brand_name) { %><span><%= item.brand_name %></span><% } %>
                  <% if (item.owner_username) { %> · <span>@<%= item.owner_username %></span><% } %>
                </div>

                <div class="pills">
                  <% if (item.category) { %><span class="pill"><%= item.category %></span><% } %>
                  <% if (item.size_label) { %><span class="pill">Size: <%= item.size_label %></span><% } %>
                  <% if (item.color) { %><span class="pill"><%= item.color %></span><% } %>
                  <% if (item.condition_grade) { %><span class="pill">Cond: <%= item.condition_grade %></span><% } %>
                </div>

                <div class="tiny mt-2">
                  Like means you’re interested. The owner picks 1 of your items before a match/chat is created.
                </div>
              </div>
            </div>
          <% }) %>
        </div>

        <div class="actions">
          <button class="action-btn btn-pass" id="btnPass" type="button" aria-label="Pass">✕</button>
          <button class="action-btn btn-like" id="btnLike" type="button" aria-label="Like">❤</button>
        </div>

        <form id="swipeForm" action="/swap/swipe" method="POST" class="d-none">
          <input type="hidden" name="item_id" id="swipeItemId" />
          <input type="hidden" name="decision" id="swipeDecision" />
        </form>

      <% } %>

    <% } %>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    (function () {
      const deck = document.getElementById('deck');
      if (!deck) return; // If mustAddSwapItem or empty state, no deck exists.

      const form = document.getElementById('swipeForm');
      const inputItemId = document.getElementById('swipeItemId');
      const inputDecision = document.getElementById('swipeDecision');

      const btnPass = document.getElementById('btnPass');
      const btnLike = document.getElementById('btnLike');

      // Assign z-index in JS (avoid VSCode linter issues in EJS)
      function assignZIndex() {
        const cards = Array.from(deck.querySelectorAll('.card-swipe'));
        cards.forEach((c, i) => c.style.zIndex = String(i + 1));
      }
      assignZIndex();

      function topCard() {
        const cards = Array.from(deck.querySelectorAll('.card-swipe'));
        let best = null;
        let bestZ = -Infinity;
        cards.forEach(c => {
          const z = parseInt(getComputedStyle(c).zIndex || '0', 10);
          if (z > bestZ) { bestZ = z; best = c; }
        });
        return best;
      }

      function setTopClass() {
        const cards = Array.from(deck.querySelectorAll('.card-swipe'));
        cards.forEach(c => c.classList.remove('is-top'));
        const t = topCard();
        if (t) t.classList.add('is-top');
      }

      function submitSwipe(itemId, decision) {
        inputItemId.value = itemId;
        inputDecision.value = decision;
        form.submit();
      }

      function animateOut(card, dir, onDone) {
        const x = dir === 'right' ? 800 : -800;
        const rot = dir === 'right' ? 18 : -18;
        card.style.transition = 'transform 260ms ease';
        card.style.transform = `translate(${x}px, 30px) rotate(${rot}deg)`;
        setTimeout(() => {
          card.remove();
          if (typeof onDone === 'function') onDone();
        }, 260);
      }

      function bindDrag(card) {
        let startX = 0, startY = 0;
        let dx = 0, dy = 0;
        let dragging = false;

        const likeBadge = card.querySelector('.badge-like');
        const nopeBadge = card.querySelector('.badge-nope');

        function setBadges(x) {
          const a = Math.min(Math.abs(x) / 120, 1);
          if (x > 0) {
            likeBadge.style.opacity = a;
            nopeBadge.style.opacity = 0;
          } else if (x < 0) {
            nopeBadge.style.opacity = a;
            likeBadge.style.opacity = 0;
          } else {
            likeBadge.style.opacity = 0;
            nopeBadge.style.opacity = 0;
          }
        }

        function onPointerDown(e) {
          dragging = true;
          card.style.transition = 'none';
          startX = e.clientX;
          startY = e.clientY;
          dx = 0;
          dy = 0;
          card.setPointerCapture(e.pointerId);
        }

        function onPointerMove(e) {
          if (!dragging) return;
          dx = e.clientX - startX;
          dy = e.clientY - startY;
          const rot = dx / 18;
          card.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`;
          setBadges(dx);
        }

        function onPointerUp() {
          if (!dragging) return;
          dragging = false;

          const threshold = 120;
          const itemId = card.getAttribute('data-item-id');

          if (dx > threshold) {
            likeBadge.style.opacity = 1;
            animateOut(card, 'right', () => submitSwipe(itemId, 'like'));
          } else if (dx < -threshold) {
            nopeBadge.style.opacity = 1;
            animateOut(card, 'left', () => submitSwipe(itemId, 'pass'));
          } else {
            card.style.transition = 'transform 220ms ease';
            card.style.transform = 'translate(0,0) rotate(0deg)';
            likeBadge.style.opacity = 0;
            nopeBadge.style.opacity = 0;
          }
        }

        card.addEventListener('pointerdown', onPointerDown);
        card.addEventListener('pointermove', onPointerMove);
        card.addEventListener('pointerup', onPointerUp);
        card.addEventListener('pointercancel', onPointerUp);
      }

      function bindTop() {
        setTopClass();
        const t = topCard();
        if (!t) return;
        bindDrag(t);
      }

      function buttonSwipe(decision) {
        const t = topCard();
        if (!t) return;
        const itemId = t.getAttribute('data-item-id');
        if (decision === 'like') {
          t.querySelector('.badge-like').style.opacity = 1;
          animateOut(t, 'right', () => submitSwipe(itemId, 'like'));
        } else {
          t.querySelector('.badge-nope').style.opacity = 1;
          animateOut(t, 'left', () => submitSwipe(itemId, 'pass'));
        }
      }

      if (btnLike) btnLike.addEventListener('click', () => buttonSwipe('like'));
      if (btnPass) btnPass.addEventListener('click', () => buttonSwipe('pass'));

      bindTop();

      const obs = new MutationObserver(() => {
        assignZIndex();
        bindTop();

        if (!topCard()) {
          if (btnLike) btnLike.disabled = true;
          if (btnPass) btnPass.disabled = true;
        }
      });
      obs.observe(deck, { childList: true });
    })();
  </script>

<!-- AI Chatbot Widget -->
<%- include('ai-chatbot-widget') %>

</body>
</html>
